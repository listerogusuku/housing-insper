<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Chegou agora no Insper? Então conheça melhor São Paulo e as opções de moradias mais recomendadas pelos alunos da instituição!"><meta name=author content="Lister Ogusuku Ribeiro"><link href=https://listerogusuku.github.io/housing-insper/desenvolvendo-a-infraestrutura/ rel=canonical><link rel=icon href=../assets/favicon.png><meta name=generator content="mkdocs-1.4.3, mkdocs-material-9.1.11"><title>Desenvolvendo a Infraestrutura - Housing Insper | Inside Insper</title><link rel=stylesheet href=../assets/stylesheets/main.85bb2934.min.css><link rel=stylesheet href=../assets/stylesheets/palette.a6bdf11c.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link rel=stylesheet href=../assets/stylesheets/custom.f7ec4df2.min.css></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#desenvolvendo-a-infraestrutura class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> Siga <strong>@insperinside</strong> no Instagram para ficar por dentro das novidades! </div> <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script> </aside> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="Housing Insper | Inside Insper" class="md-header__button md-logo" aria-label="Housing Insper | Inside Insper" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"> <path d=M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z /> <path d=M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z style="fill-opacity: 0.5"/> <path d=M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z /> <path d=M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z style="fill-opacity: 0.25"/> </svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Housing Insper | Inside Insper </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Desenvolvendo a Infraestrutura </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/listerogusuku/housing-insper title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> listerogusuku/housing-insper </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Página Inicial </a> </li> <li class=md-tabs__item> <a href=../Sao-Paulo-life/ class=md-tabs__link> A vida em São Paulo </a> </li> <li class=md-tabs__item> <a href=../about-housing-insper/ class=md-tabs__link> Moradias </a> </li> <li class=md-tabs__item> <a href=../vagas-aptos-insper/ class=md-tabs__link> Vagas em apartamentos divulgadas por alunos do Insper </a> </li> <li class=md-tabs__item> <a href=../toca-da-raposa/ class=md-tabs__link> Toca da Raposa (para bolsistas integrais) </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="Housing Insper | Inside Insper" class="md-nav__button md-logo" aria-label="Housing Insper | Inside Insper" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"> <path d=M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z /> <path d=M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z style="fill-opacity: 0.5"/> <path d=M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z /> <path d=M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z style="fill-opacity: 0.25"/> </svg> </a> Housing Insper | Inside Insper </label> <div class=md-nav__source> <a href=https://github.com/listerogusuku/housing-insper title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> listerogusuku/housing-insper </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> Página Inicial </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> A vida em São Paulo <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> A vida em São Paulo </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Sao-Paulo-life/ class=md-nav__link> A Vida em São Paulo </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> Moradias <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Moradias </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../about-housing-insper/ class=md-nav__link> Confira as opções de moradias </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../vagas-aptos-insper/ class=md-nav__link> Vagas em apartamentos divulgadas por alunos do Insper </a> </li> <li class=md-nav__item> <a href=../toca-da-raposa/ class=md-nav__link> Toca da Raposa (para bolsistas integrais) </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#sobre-o-projeto class=md-nav__link> Sobre o Projeto </a> </li> <li class=md-nav__item> <a href=#desenvolvendo-a-infraestrutura_1 class=md-nav__link> Desenvolvendo a infraestrutura </a> <nav class=md-nav aria-label="Desenvolvendo a infraestrutura"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-pre-requisitos class=md-nav__link> 1. Pré-requisitos </a> </li> <li class=md-nav__item> <a href=#2-instalacao-do-terraform class=md-nav__link> 2. Instalação do Terraform </a> </li> <li class=md-nav__item> <a href=#3-utilizacao class=md-nav__link> 3. Utilização </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#credenciais-aws-no-terraform class=md-nav__link> Credenciais AWS no Terraform </a> </li> <li class=md-nav__item> <a href=#rodando-a-aplicacao-se-voce-desejar-apenas-rodar-a-infra-ja-criada class=md-nav__link> Rodando a aplicação (se você desejar APENAS rodar a infra já criada) </a> </li> <li class=md-nav__item> <a href=#criando-a-infraestrutura-do-zero class=md-nav__link> Criando a infraestrutura do zero </a> </li> <li class=md-nav__item> <a href=#criando-uma-funcao-lambda-no-terraform class=md-nav__link> Criando uma função Lambda no Terraform </a> </li> <li class=md-nav__item> <a href=#criando-o-provider class=md-nav__link> Criando o provider </a> </li> <li class=md-nav__item> <a href=#bucket-do-s3 class=md-nav__link> Bucket do S3 </a> </li> <li class=md-nav__item> <a href=#iam-e-policies class=md-nav__link> IAM e Policies </a> </li> <li class=md-nav__item> <a href=#criando-uma-funcao-lambda class=md-nav__link> Criando uma função Lambda </a> </li> <li class=md-nav__item> <a href=#criando-o-cloudwatch class=md-nav__link> Criando o CloudWatch </a> </li> <li class=md-nav__item> <a href=#inicializando-o-terraform class=md-nav__link> Inicializando o Terraform </a> </li> <li class=md-nav__item> <a href=#criando-o-api-gateway class=md-nav__link> Criando o API Gateway </a> </li> <li class=md-nav__item> <a href=#integrando-o-api-gateway-com-o-lambda class=md-nav__link> Integrando o API Gateway com o Lambda </a> </li> <li class=md-nav__item> <a href=#invocando-o-lambda class=md-nav__link> Invocando o Lambda </a> </li> <li class=md-nav__item> <a href=#hora-de-testar class=md-nav__link> Hora de testar </a> </li> <li class=md-nav__item> <a href=#criando-funcao-lambda-com-dependencias-externas-e-acesso-ao-bucket-s3 class=md-nav__link> Criando função lambda com dependências externas e acesso ao bucket S3 </a> </li> <li class=md-nav__item> <a href=#conclusao class=md-nav__link> Conclusão </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/listerogusuku/housing-insper/edit/master/docs/desenvolvendo-a-infraestrutura.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg> </a> <a href=https://github.com/listerogusuku/housing-insper/raw/master/docs/desenvolvendo-a-infraestrutura.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.15 8.15 0 0 1-1.23-2Z"/></svg> </a> <h1 id=desenvolvendo-a-infraestrutura>Desenvolvendo a Infraestrutura<a class=headerlink href=#desenvolvendo-a-infraestrutura title="Permanent link">&para;</a></h1> <h2 id=sobre-o-projeto><img alt=📝 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f4dd.svg title=:pencil:> Sobre o Projeto<a class=headerlink href=#sobre-o-projeto title="Permanent link">&para;</a></h2> <p>O Projeto a seguir visa aplicar conceitos de Computação em Nuvem (Cloud Computing) por meio da plataforma de serviços de Computação em Nuvem <a href=https://aws.amazon.com/pt/what-is-aws/ target=_blank><strong>AWS (Amazon Web Services).</strong></a> A ideia é subir uma aplicação sem servidor na AWS utilizando o <strong><a href=https://aws.amazon.com/pt/s3/ target=_blank>S3</a>, <a href=https://aws.amazon.com/pt/lambda/ target=_blank>Lambda</a>, <a href=https://aws.amazon.com/pt/api-gateway/ target=_blank>API Gateway</a> e o <a href=https://aws.amazon.com/pt/cloudwatch/ target=_blank>CloudWatch</a></strong> colocando em prática os conceitos de <strong>IaaC (Infrastructure as a Code)</strong> por meio do Terraform. O diagrama visual da aplicação pode ser conferido a seguir:</p> <p><img alt="Diagrama da Aplicação" src=./screenshots/DIAGRAMA_CLOUD.png></p> <h2 id=desenvolvendo-a-infraestrutura_1>Desenvolvendo a infraestrutura<a class=headerlink href=#desenvolvendo-a-infraestrutura_1 title="Permanent link">&para;</a></h2> <h3 id=1-pre-requisitos>1. Pré-requisitos<a class=headerlink href=#1-pre-requisitos title="Permanent link">&para;</a></h3> <ul> <li>Para rodar nossa infraestrutura, estamos utilizando o <strong>Ubuntu 22.04.2 LTS</strong> (o qual já estava instalado no nosso Windows). A infra pode funcionar em outras versões, porém <strong><em>não há garantia de funcionamento.</em></strong> Assim sendo, indicamos o uso da versão supracitada para testar nossa aplicação (e até mesmo para criar e rodar a sua própria).</li> </ul> <p><img alt=ubuntu src=screenshots/ubuntu.png></p> <ul> <li> <p>Conta no <a href=https://docs.aws.amazon.com/codedeploy/latest/userguide/tutorials-github-create-github-account.html><strong>Github</strong></a> (+ <a href=https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token>token de autorização</a>, <em>se necessário</em>, com permissão de criação e atualização de repositórios), caso você desejar subir e deixar o projeto registrado.</p> </li> <li> <p><a href=https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-ubuntu-20-04>Node.js instalado na máquina.</a> (no caso, instalei diretamente dentro do Ubuntu 22.04.2 LTS via terminal).</p> </li> <li> <p><a href=https://docs.aws.amazon.com/pt_br/lex/latest/dg/gs-account.html target=_blank>Conta na AWS com usuário com permissões de Administrador.</a></p> </li> <li> <p>Terraform instalado na máquina (no caso, instalei diretamente dentro do Ubuntu 22.04.2 LTS e explico no próximo tópico como fazer você também).</p> </li> <li> <p><a href=https://code.visualstudio.com target=_blank>Visual Studio Code (VS Code).</a></p> </li> <li> <p><a href=https://docs.aws.amazon.com/pt_br/cli/latest/userguide/getting-started-install.html target=_blank>AWS CLI</a></p> </li> </ul> <h3 id=2-instalacao-do-terraform>2. Instalação do Terraform<a class=headerlink href=#2-instalacao-do-terraform title="Permanent link">&para;</a></h3> <p><img alt="Terraform image" src=https://upload.wikimedia.org/wikipedia/commons/0/04/Terraform_Logo.svg></p> <p>A primeira etapa para desenvolvermos essa aplicação é instalar o Terraform na máquina. O Terraform é uma <strong>ferramenta de gerenciamento de infraestrutura como código (IaC)</strong> desenvolvida pela HashiCorp. Ele permite que os usuários definam, configurem e provisionem infraestruturas de forma automatizada e reprodutível, usando uma linguagem declarativa e uma sintaxe simples. Com o Terraform, é possível criar e gerenciar recursos em diferentes provedores de nuvem, como AWS, Google Cloud, Azure e outros, bem como em plataformas de infraestrutura, como Kubernetes, Docker e OpenStack. Em resumo, <strong>o Terraform é uma ferramenta importante para automatizar e gerenciar infraestruturas de nuvem e outras plataformas de infraestrutura, tornando a gestão de infraestrutura escalável, segura e repetível.</strong> <em>Sim, é o Terraform quem irá nos auxiliar a não ter que ficar fazendo tudo manualmente no dashboard da AWS, como acabamos de fazer na página anterior.</em></p> <p>Caso você não possua o Terraform no seu computador, é necessário baixar e instalar de acordo com o tutorial presente <a href="https://www.youtube.com/watch?v=bSrV1Dr8py8">neste link (Windows)</a> ou diretamente <a href=https://developer.hashicorp.com/terraform/downloads>neste link (Ubuntu/Linux - Recomendado)</a>.</p> <h3 id=3-utilizacao>3. Utilização<a class=headerlink href=#3-utilizacao title="Permanent link">&para;</a></h3> <p>Após a instalação do Terraform na máquina, já é possível rodar a infraestrutura desenvolvida ou criar sua própria infraestrutura com base em tudo que está sendo apresentado aqui.</p> <p>O primeiro passo é <strong>clonar este repositório</strong> em uma pasta dentro do seu computador. <em>Caso não saiba como clonar um repositório na sua máquina local, acesse o tutorial presente <a href=https://docs.github.com/pt/repositories/creating-and-managing-repositories/cloning-a-repository>neste link</a> ou faça o download do respositório e descompacte o arquivo .zip no local desejado.</em></p> <div class="admonition dica"> <p class=admonition-title>Dica</p> <p><strong><em>Caso você desejar criar a infraestrutura do zero, segui e sugiro a seguinte estrutura de pastas:</em></strong></p> </div> <div class="language-text highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>Cloud-Project
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>│
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>│
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>└───hello
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>│   |---function.js
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>│
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>└───s3
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>|   │---function.js
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>│
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>│───Terraform
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>│   |---api-gateway.tf
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>│   |
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>│   |---hello-api-gateway.tf
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>│   |
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>│   |---hello-lamba.tf
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>│   |
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>│   |---lambda-s3-bucket.tf
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>│   |
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>│   |---provider.tf
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>│   |
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>│   |---s3-lambda.tf
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>│   |
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a>│   |---test-bucket.tf
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a>│   |
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a>│   |---terraform.sh
</span></code></pre></div> <p>Independentemente se você escolheu clonar o repositório com a infraestrutura original ou se tiver escolhido criar do zero, <strong>lembre-se que tudo deve ser feito dentro do prompt de comando do Ubuntu 22.04.2 LTS</strong> caso deseje chegar nos mesmos resultados apresentados aqui sem grandes riscos de problemas.</p> <hr> <!-- !!! info
Essas duas partes são obrigatórias no tutorial:

    - Nome de vocês
    - Começando
    - Motivação --> <h2 id=credenciais-aws-no-terraform>Credenciais AWS no Terraform<a class=headerlink href=#credenciais-aws-no-terraform title="Permanent link">&para;</a></h2> <p>Antes de darmos início, é necessário <strong>cadastrar suas credenciais AWS na sua máquina.</strong> Temos várias formas de fazer isso, porém iremos optar pela alternativa que eu considero mais segura para quem está iniciando na AWS (incluindo eu mesmo): cadastrar diretamente via terminal. <em>Sim, pode haver várias outras formas de fazer isso, então se você considera alguma outra melhor, fique à vontade.</em></p> <p>Você deve possuir um .csv com a chave de acesso (Secret Key) e a chave secreta (Secret Access Key) de acesso da sua conta AWS, precisaremos dessas informações agora.</p> <div class="admonition warning"> <p class=admonition-title>Aviso</p> <p>A partir de agora, todos os comandos que utilizarmos ou alterações realizadas via prompt de comando deve ser feitas dentro da pasta que designamos para trabalhar neste projeto. Eu optei por trabalhar dentro da raiz da minha máquina, ou seja, <strong>dentro do meu diretório</strong>, estou trabalhando na seguinte pasta:</p> <p>root@Lister:/mnt/c/Computacao_em_Nuvem/testando-o-projeto-01/Cloud-Project</p> </div> <div class="admonition dica"> <p class=admonition-title>Dica</p> <p>Para manipular arquivos dentro do terminal do Ubuntu, utilize os comandos:</p> <p><strong>cd</strong> &rarr; Para navegar entre as pastas dentro do seu computador;</p> <p><strong>ls</strong> &rarr; para visualizar os arquivos dentro das pastas;</p> <p>Exemplo de uso:</p> <p><strong>cd /mnt/c</strong> &rarr; Entrei na raiz do meu computador;</p> <p><strong>cd ..</strong> &rarr; Sai da raiz e "voltei um caminho", ou seja, agora estou no diretório "/mnt";</p> <p><strong>code .</strong> &rarr; Abre toda sua pasta dentro do VS Code (isso sempre me ajuda muito).</p> </div> <p>Dentro do terminal Ubuntu, insira os comandos:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>aws configure
</span></code></pre></div> <p>Após o comando acima, serão solicitadas as suas chaves de acesso. Coloque-as no terminal como solicitado e bora trabalhar!</p> <h2 id=rodando-a-aplicacao-se-voce-desejar-apenas-rodar-a-infra-ja-criada>Rodando a aplicação (se você desejar APENAS rodar a infra já criada)<a class=headerlink href=#rodando-a-aplicacao-se-voce-desejar-apenas-rodar-a-infra-ja-criada title="Permanent link">&para;</a></h2> <p>Caso você desejar <strong>criar a infra (tal como sugerido e explicado detalhadamente neste handout)</strong>, vá para a aba <strong><a href=https://listerogusuku.github.io/Cloud-Project/desenvolvendo-a-infraestrutura/#criando-a-infraestrutura-do-zero>"Criando a infraestrutura do zero"</a></strong> e continue o handout. Caso desejar <strong>apenas rodá-la</strong>, entre na pasta que você clonou a infra e, dentro do diretório "Cloud-Project/terraform" rode os seguintes comandos:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>terraform init
</span></code></pre></div> <p><img alt="TERRAFORM INIT" src=./screenshots/terraform_init.png></p> <p>E, em seguida, rode:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>terraform plan
</span></code></pre></div> <blockquote> <p>The <strong><em>terraform plan command</em></strong> creates an execution plan, which lets you preview the changes that Terraform plans to make to your infrastructure. <em>(Texto extraído do site da Hashicorp)</em></p> <p>O comando <strong><em>terraform plan</em></strong> cria um plano de execução, que permite visualizar as alterações que o Terraform planeja fazer em sua infraestrutura. <em>(Texto traduzido do site da Hashicorp)</em></p> </blockquote> <p>E, para finalizar, rode:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>terraform apply
</span></code></pre></div> <p><img alt="TERRAFORM INIT" src=./screenshots/terraform_apply.png></p> <p>Após tudo ter funcionado, <strong>a infra foi construída na AWS</strong>, agora é só testar!</p> <div class="admonition dica"> <p class=admonition-title>Dica</p> <p>Entre na sua <strong>dashboard da AWS</strong>, verifique todos os serviços criados e <strong>tente entender como tudo foi criado e o que está acontecendo entre os serviços</strong> (para isso, observar o diagrama apresentado no início do handout pode ajudar).</p> </div> <p>Para testar, digite no terminal:</p> <div class="language-tf highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=err>curl</span><span class=w> </span><span class=err>-X</span><span class=w> </span><span class=err>POST</span><span class=w> </span>\
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=err>-H</span><span class=w> </span><span class=s2>&quot;Content-Type: application/json&quot;</span><span class=w> </span>\
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=err>-d</span><span class=w> </span><span class=err>&#39;</span><span class=p>{</span><span class=s2>&quot;name&quot;</span><span class=o>:</span><span class=s2>&quot;Insper&quot;</span><span class=p>}</span><span class=err>&#39;</span><span class=w> </span>\
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=s2>&quot;https://&lt;id&gt;.execute-api.us-east-1.amazonaws.com/dev/hello&quot;</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=w>          </span><span class=err>/</span>\
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=w>          </span><span class=err>||</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=err>Substitua</span><span class=w> </span><span class=err>&lt;id&gt;</span><span class=w> </span><span class=err>pelo</span><span class=w> </span><span class=err>seu</span><span class=w> </span><span class=err>id</span><span class=w> </span><span class=err>retornado</span><span class=w> </span><span class=err>no</span><span class=w> </span><span class=err>prompt</span><span class=w> </span><span class=err>de</span><span class=w> </span><span class=err>comando</span>
</span></code></pre></div> <div class="admonition dica"> <p class=admonition-title>Dica</p> <p>Além do prompt de comando, teste também diretamente no seu navegador! Para fazer isso, basta substituir a url que foi retornada e passar algum parâmetro após "Name", da seguinte forma:</p> <p>https:// SEU-ID-AQUI .execute-api.us-east-1.amazonaws.com/dev/hello <strong>+ o parâmetro</strong> ?Name=Lister</p> <p>Por exemplo:</p> <p><a href="https://2cmcnumb2l.execute-api.us-east-1.amazonaws.com/dev/hello?Name=Lister">https://2cmcnumb2l.execute-api.us-east-1.amazonaws.com/dev/hello?Name=Lister</a></p> </div> <p>Podemos também invocar essa função com o nome do bucket reebido no prompt de comando + nosso objeto para ver se o lambda conseguirá obter o objeto do bucket.</p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>aws<span class=w> </span>lambda<span class=w> </span>invoke<span class=w> </span><span class=se>\</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>--region<span class=o>=</span>us-east-1<span class=w> </span><span class=se>\</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>--function-name<span class=o>=</span>s3<span class=w> </span><span class=se>\</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>--cli-binary-format<span class=w> </span>raw-in-base64-out<span class=w> </span><span class=se>\</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>--payload<span class=w> </span><span class=s1>&#39;{&quot;bucket&quot;:&quot;test-&lt;your&gt;-&lt;name&gt;&quot;,&quot;object&quot;:&quot;hello.json&quot;}&#39;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>response.json
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=w>                             </span>/<span class=se>\</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>                             </span><span class=o>||</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>      </span>Substitua<span class=w> </span>test-&lt;your&gt;-&lt;name&gt;<span class=w> </span>pelo<span class=w> </span>nome<span class=w> </span><span class=k>do</span><span class=w> </span>seu<span class=w> </span>bucket
</span></code></pre></div> <p>Rode no terminal o seguinte comando:</p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>cat<span class=w> </span>response.json
</span></code></pre></div> <p><span class="twemoji mdx-heart"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14 20.408c-.492.308-.903.546-1.192.709-.153.086-.308.17-.463.252h-.002a.75.75 0 0 1-.686 0 16.709 16.709 0 0 1-.465-.252 31.147 31.147 0 0 1-4.803-3.34C3.8 15.572 1 12.331 1 8.513 1 5.052 3.829 2.5 6.736 2.5 9.03 2.5 10.881 3.726 12 5.605 13.12 3.726 14.97 2.5 17.264 2.5 20.17 2.5 23 5.052 23 8.514c0 3.818-2.801 7.06-5.389 9.262A31.146 31.146 0 0 1 14 20.408Z"/></svg></span> &nbsp; Se você receber como retorno <strong><em>Yeah, I am working from Insper, Avelinux :)</em></strong>, parabéns, você concluiu sua aplicação e ela está funcionando!</p> <div class="admonition warning"> <p class=admonition-title>Dica Visual</p> <p>Se entrarmos no dashboard do <strong>CloudWatch</strong> novamente, conseguiremos ver os logs de acesso registrados para nossas solicitações.</p> </div> <h2 id=criando-a-infraestrutura-do-zero>Criando a infraestrutura do zero<a class=headerlink href=#criando-a-infraestrutura-do-zero title="Permanent link">&para;</a></h2> <h2 id=criando-uma-funcao-lambda-no-terraform>Criando uma função Lambda no Terraform<a class=headerlink href=#criando-uma-funcao-lambda-no-terraform title="Permanent link">&para;</a></h2> <p>O primeiro passo será criarmos uma função lambda que, futuramente, será integrada com o AWS API Gateway.</p> <p>Mas o que é o "Lambda"?</p> <p>A AWS Lambda é um <strong>serviço de computação sem servidor</strong> que permite executar código de forma escalável e <strong>sem a necessidade de gerenciar servidores.</strong> Ela é projetada para responder a eventos específicos, como <strong>alterações em um bucket do Amazon S3 ou atualizações em uma tabela do Amazon DynamoDB.</strong></p> <p>Inicialmente, começaremos com uma função simples baseada em <strong>NodeJS</strong> sem nenhuma dependência.</p> <!--
!!! note
Bloco de destaque de texto, pode ser:

    - note, example, warning, info, tip, danger

!!! example "Faça assim"
É possível editar o título desses blocos

    !!! warning
        Isso também é possível de ser feito, mas
        use com parcimonia.

??? info
Também da para esconder o texto, usar para coisas
muito grandes, ou exemplos de códigos.

    <div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>...
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>oi!
</span></code></pre></div>

- **Esse é um texto em destaque**
- ==Pode fazer isso também==

Usar emojis da lista:

:two_hearts: - https://github.com/caiyongji/emoji-list --> <div class="tabbed-set tabbed-alternate" data-tabs=1:1><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1><strong>index.js</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-js highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-9-1> 1</a></span>
<span class=normal><a href=#__codelineno-9-2> 2</a></span>
<span class=normal><a href=#__codelineno-9-3> 3</a></span>
<span class=normal><a href=#__codelineno-9-4> 4</a></span>
<span class=normal><a href=#__codelineno-9-5> 5</a></span>
<span class=normal><a href=#__codelineno-9-6> 6</a></span>
<span class=normal><a href=#__codelineno-9-7> 7</a></span>
<span class=normal><a href=#__codelineno-9-8> 8</a></span>
<span class=normal><a href=#__codelineno-9-9> 9</a></span>
<span class=normal><a href=#__codelineno-9-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1></a><span class=nx>exports</span><span class=p>.</span><span class=nx>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&quot;Event: &quot;</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>);</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>responseMessage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;Hello, World!&quot;</span><span class=p>;</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4></a>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>queryStringParameters</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>queryStringParameters</span><span class=p>[</span><span class=s2>&quot;Name&quot;</span><span class=p>])</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6></a><span class=w>    </span><span class=nx>responseMessage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;Hello, &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>queryStringParameters</span><span class=p>[</span><span class=s2>&quot;Name&quot;</span><span class=p>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s2>&quot;!&quot;</span><span class=p>;</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8></a>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=nx>response</span><span class=p>;</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10></a><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>Ao invocar essa função com uma consulta de URL e com o parâmetro Name definido, ela retornará "Hello, <em>Name</em>!".</p> <div class="tabbed-set tabbed-alternate" data-tabs=2:1><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1><strong>index.js</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-js highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-10-1> 1</a></span>
<span class=normal><a href=#__codelineno-10-2> 2</a></span>
<span class=normal><a href=#__codelineno-10-3> 3</a></span>
<span class=normal><a href=#__codelineno-10-4> 4</a></span>
<span class=normal><a href=#__codelineno-10-5> 5</a></span>
<span class=normal><a href=#__codelineno-10-6> 6</a></span>
<span class=normal><a href=#__codelineno-10-7> 7</a></span>
<span class=normal><a href=#__codelineno-10-8> 8</a></span>
<span class=normal><a href=#__codelineno-10-9> 9</a></span>
<span class=normal><a href=#__codelineno-10-10>10</a></span>
<span class=normal><a href=#__codelineno-10-11>11</a></span>
<span class=normal><a href=#__codelineno-10-12>12</a></span>
<span class=normal><a href=#__codelineno-10-13>13</a></span>
<span class=normal><a href=#__codelineno-10-14>14</a></span>
<span class=normal><a href=#__codelineno-10-15>15</a></span>
<span class=normal><a href=#__codelineno-10-16>16</a></span>
<span class=normal><a href=#__codelineno-10-17>17</a></span>
<span class=normal><a href=#__codelineno-10-18>18</a></span>
<span class=normal><a href=#__codelineno-10-19>19</a></span>
<span class=normal><a href=#__codelineno-10-20>20</a></span>
<span class=normal><a href=#__codelineno-10-21>21</a></span>
<span class=normal><a href=#__codelineno-10-22>22</a></span>
<span class=normal><a href=#__codelineno-10-23>23</a></span>
<span class=normal><a href=#__codelineno-10-24>24</a></span>
<span class=normal><a href=#__codelineno-10-25>25</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1></a><span class=nx>exports</span><span class=p>.</span><span class=nx>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&quot;Event: &quot;</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>);</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>responseMessage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;Hello, World!&quot;</span><span class=p>;</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4></a>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>queryStringParameters</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>queryStringParameters</span><span class=p>[</span><span class=s2>&quot;Name&quot;</span><span class=p>])</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6></a><span class=w>    </span><span class=nx>responseMessage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;Hello, &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>queryStringParameters</span><span class=p>[</span><span class=s2>&quot;Name&quot;</span><span class=p>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s2>&quot;!&quot;</span><span class=p>;</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8></a>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9></a><span class=o>+</span><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>httpMethod</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s2>&quot;POST&quot;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10></a><span class=o>+</span><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>body</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>body</span><span class=p>);</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11></a><span class=o>+</span><span class=w>    </span><span class=nx>responseMessage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;Hello, &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>body</span><span class=p>.</span><span class=nx>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s2>&quot;!&quot;</span><span class=p>;</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12></a><span class=o>+</span><span class=w>  </span><span class=p>}</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13></a>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14></a><span class=o>+</span><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15></a><span class=o>+</span><span class=w>    </span><span class=nx>statusCode</span><span class=o>:</span><span class=w> </span><span class=mf>200</span><span class=p>,</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16></a><span class=o>+</span><span class=w>    </span><span class=nx>headers</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17></a><span class=o>+</span><span class=w>      </span><span class=s2>&quot;Content-Type&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;application/json&quot;</span><span class=p>,</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18></a><span class=o>+</span><span class=w>    </span><span class=p>},</span>
</span><span id=__span-10-19><a id=__codelineno-10-19 name=__codelineno-10-19></a><span class=o>+</span><span class=w>    </span><span class=nx>body</span><span class=o>:</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span><span id=__span-10-20><a id=__codelineno-10-20 name=__codelineno-10-20></a><span class=o>+</span><span class=w>      </span><span class=nx>message</span><span class=o>:</span><span class=w> </span><span class=nx>responseMessage</span><span class=p>,</span>
</span><span id=__span-10-21><a id=__codelineno-10-21 name=__codelineno-10-21></a><span class=o>+</span><span class=w>    </span><span class=p>}),</span>
</span><span id=__span-10-22><a id=__codelineno-10-22 name=__codelineno-10-22></a><span class=o>+</span><span class=w>  </span><span class=p>};</span>
</span><span id=__span-10-23><a id=__codelineno-10-23 name=__codelineno-10-23></a>
</span><span id=__span-10-24><a id=__codelineno-10-24 name=__codelineno-10-24></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=nx>response</span><span class=p>;</span>
</span><span id=__span-10-25><a id=__codelineno-10-25 name=__codelineno-10-25></a><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>Também será verificado o método <strong>HTTP GET e POST</strong> para que seja verificada a resposta padrão. Foi especificado o <strong>código de status '200', tipo de conteúdo e a mensagem</strong> para ser retornada ao chamador.</p> <h2 id=criando-o-provider>Criando o provider<a class=headerlink href=#criando-o-provider title="Permanent link">&para;</a></h2> <p>Agora que nossa handler já está pronta, começaremos a trabalhar em alguns elementos do nosso Terraform. Criaremos os arquivos <strong><em>.tf</em></strong> dentro de uma pasta intitulada (por motivos intuitivos, claro) como "terraform".</p> <p>Começaremos criando o arquivo "provider.tf", em que serão declaradas as restrições de versão (região da AWS, por exemplo) para os diferentes provedores AWS, versões de Teraform e afins.</p> <p>Isso é feito apenas para que, caso alguém pegue esse projeto no futuro e rode em outra versão de Terraform ou com configurações diferentes das que foram aqui padronizadas, o projeto não funcione.</p> <div class="tabbed-set tabbed-alternate" data-tabs=3:1><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><div class=tabbed-labels><label for=__tabbed_3_1><strong>terraform/provider.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-11-1> 1</a></span>
<span class=normal><a href=#__codelineno-11-2> 2</a></span>
<span class=normal><a href=#__codelineno-11-3> 3</a></span>
<span class=normal><a href=#__codelineno-11-4> 4</a></span>
<span class=normal><a href=#__codelineno-11-5> 5</a></span>
<span class=normal><a href=#__codelineno-11-6> 6</a></span>
<span class=normal><a href=#__codelineno-11-7> 7</a></span>
<span class=normal><a href=#__codelineno-11-8> 8</a></span>
<span class=normal><a href=#__codelineno-11-9> 9</a></span>
<span class=normal><a href=#__codelineno-11-10>10</a></span>
<span class=normal><a href=#__codelineno-11-11>11</a></span>
<span class=normal><a href=#__codelineno-11-12>12</a></span>
<span class=normal><a href=#__codelineno-11-13>13</a></span>
<span class=normal><a href=#__codelineno-11-14>14</a></span>
<span class=normal><a href=#__codelineno-11-15>15</a></span>
<span class=normal><a href=#__codelineno-11-16>16</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1></a><span class=nb>terraform</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2></a><span class=w>    </span><span class=nb>required_providers</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3></a><span class=w>    </span><span class=nb>aws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4></a><span class=w>        </span><span class=na>source</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;hashicorp/aws&quot;</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5></a><span class=w>        </span><span class=na>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;~&gt; 4.21.0&quot;</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7></a><span class=c1>    # Aqui dentro poderíamos também ter estabelecido outras restrições</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8></a><span class=c1>    # de versão, mas optei por deixar o mais simples possível.</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10></a>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11></a><span class=na>required_version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;~&gt; 1.0&quot;</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12></a><span class=p>}</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13></a>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14></a><span class=kr>provider</span><span class=w> </span><span class=nv>&quot;aws&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15></a><span class=w>    </span><span class=na>region</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;us-east-1&quot;</span><span class=c1> # Região Northern Virginia</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h2 id=bucket-do-s3>Bucket do S3<a class=headerlink href=#bucket-do-s3 title="Permanent link">&para;</a></h2> <p>Agora nós construiremos uma função com todas as dependências, empacotaremos como um arquivo <strong><em>zip</em></strong> para que, assim, consigamos subir num bucket do S3. Ou seja, quando criamos o lambda, apontamos para esse objeto de arquvo zip no bucket S3.</p> <p>Como os nomes dos buckets do S3 devem ser <strong>únicos e exclusivos</strong> no mundo inteiro, podemos utilizar um gerador aleatório para nos ajudar a nomear nosso bucket S3.</p> <div class="tabbed-set tabbed-alternate" data-tabs=4:1><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><div class=tabbed-labels><label for=__tabbed_4_1><strong>terraform/lambda-bucket.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-12-1>1</a></span>
<span class=normal><a href=#__codelineno-12-2>2</a></span>
<span class=normal><a href=#__codelineno-12-3>3</a></span>
<span class=normal><a href=#__codelineno-12-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;random_pet&quot;</span><span class=w> </span><span class=nv>&quot;lambda_bucket_name&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2></a><span class=na>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;lambda&quot;</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3></a><span class=na>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>2</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Em seguida, vamos criar o próprio bucket do S3 com o nome gerado.</p> <div class="tabbed-set tabbed-alternate" data-tabs=5:1><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><div class=tabbed-labels><label for=__tabbed_5_1><strong>terraform/lambda-bucket.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-13-1>1</a></span>
<span class=normal><a href=#__codelineno-13-2>2</a></span>
<span class=normal><a href=#__codelineno-13-3>3</a></span>
<span class=normal><a href=#__codelineno-13-4>4</a></span>
<span class=normal><a href=#__codelineno-13-5>5</a></span>
<span class=normal><a href=#__codelineno-13-6>6</a></span>
<span class=normal><a href=#__codelineno-13-7>7</a></span>
<span class=normal><a href=#__codelineno-13-8>8</a></span>
<span class=normal><a href=#__codelineno-13-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;random_pet&quot;</span><span class=w> </span><span class=nv>&quot;lambda_bucket_name&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2></a><span class=w>  </span><span class=na>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;lambda&quot;</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3></a><span class=w>  </span><span class=na>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>2</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4></a><span class=p>}</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5></a>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6></a><span class=err>+</span><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_s3_bucket&quot;</span><span class=w> </span><span class=nv>&quot;lambda_bucket&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7></a><span class=err>+</span><span class=w>  </span><span class=na>bucket</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=nv>random_pet.lambda_bucket_name.id</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8></a><span class=err>+</span><span class=w>  </span><span class=na>force_destroy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9></a><span class=err>+</span><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Por padrão, deixaremos todo o acesso público ao bucket bloqueado.</p> <div class="tabbed-set tabbed-alternate" data-tabs=6:1><input checked=checked id=__tabbed_6_1 name=__tabbed_6 type=radio><div class=tabbed-labels><label for=__tabbed_6_1><strong>terraform/lambda-bucket.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-14-1> 1</a></span>
<span class=normal><a href=#__codelineno-14-2> 2</a></span>
<span class=normal><a href=#__codelineno-14-3> 3</a></span>
<span class=normal><a href=#__codelineno-14-4> 4</a></span>
<span class=normal><a href=#__codelineno-14-5> 5</a></span>
<span class=normal><a href=#__codelineno-14-6> 6</a></span>
<span class=normal><a href=#__codelineno-14-7> 7</a></span>
<span class=normal><a href=#__codelineno-14-8> 8</a></span>
<span class=normal><a href=#__codelineno-14-9> 9</a></span>
<span class=normal><a href=#__codelineno-14-10>10</a></span>
<span class=normal><a href=#__codelineno-14-11>11</a></span>
<span class=normal><a href=#__codelineno-14-12>12</a></span>
<span class=normal><a href=#__codelineno-14-13>13</a></span>
<span class=normal><a href=#__codelineno-14-14>14</a></span>
<span class=normal><a href=#__codelineno-14-15>15</a></span>
<span class=normal><a href=#__codelineno-14-16>16</a></span>
<span class=normal><a href=#__codelineno-14-17>17</a></span>
<span class=normal><a href=#__codelineno-14-18>18</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;random_pet&quot;</span><span class=w> </span><span class=nv>&quot;lambda_bucket_name&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2></a><span class=w>  </span><span class=na>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;lambda&quot;</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3></a><span class=w>  </span><span class=na>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>2</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4></a><span class=p>}</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5></a>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_s3_bucket&quot;</span><span class=w> </span><span class=nv>&quot;lambda_bucket&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7></a><span class=w>  </span><span class=na>bucket</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=nv>random_pet.lambda_bucket_name.id</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8></a><span class=w>  </span><span class=na>force_destroy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9></a><span class=p>}</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10></a>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11></a><span class=err>+</span><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_s3_bucket_public_access_block&quot;</span><span class=w> </span><span class=nv>&quot;lambda_bucket&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12></a><span class=err>+</span><span class=w>  </span><span class=na>bucket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_bucket.lambda_bucket.id</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13></a>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14></a><span class=err>+</span><span class=w>  </span><span class=na>block_public_acls</span><span class=w>       </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15></a><span class=err>+</span><span class=w>  </span><span class=na>block_public_policy</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16></a><span class=err>+</span><span class=w>  </span><span class=na>ignore_public_acls</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17></a><span class=err>+</span><span class=w>  </span><span class=na>restrict_public_buckets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18></a><span class=err>+</span><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h2 id=iam-e-policies>IAM e Policies<a class=headerlink href=#iam-e-policies title="Permanent link">&para;</a></h2> <p>Agora criaremos o código Terraform do lambda. Lembrando que o lambda exigirá acesso a outros serviços da AWS (como o CloudWatch, para gravar logs) e, no nosso caso, concederemos acesso ao bucket do S3 para que seja possível a leitura de um arquivo.</p> <p>Para isso, precisamos criar uma função do IAM e permitir que o lambda a use.</p> <div class="tabbed-set tabbed-alternate" data-tabs=7:1><input checked=checked id=__tabbed_7_1 name=__tabbed_7 type=radio><div class=tabbed-labels><label for=__tabbed_7_1><strong>terraform/hello-lambda.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-15-1> 1</a></span>
<span class=normal><a href=#__codelineno-15-2> 2</a></span>
<span class=normal><a href=#__codelineno-15-3> 3</a></span>
<span class=normal><a href=#__codelineno-15-4> 4</a></span>
<span class=normal><a href=#__codelineno-15-5> 5</a></span>
<span class=normal><a href=#__codelineno-15-6> 6</a></span>
<span class=normal><a href=#__codelineno-15-7> 7</a></span>
<span class=normal><a href=#__codelineno-15-8> 8</a></span>
<span class=normal><a href=#__codelineno-15-9> 9</a></span>
<span class=normal><a href=#__codelineno-15-10>10</a></span>
<span class=normal><a href=#__codelineno-15-11>11</a></span>
<span class=normal><a href=#__codelineno-15-12>12</a></span>
<span class=normal><a href=#__codelineno-15-13>13</a></span>
<span class=normal><a href=#__codelineno-15-14>14</a></span>
<span class=normal><a href=#__codelineno-15-15>15</a></span>
<span class=normal><a href=#__codelineno-15-16>16</a></span>
<span class=normal><a href=#__codelineno-15-17>17</a></span>
<span class=normal><a href=#__codelineno-15-18>18</a></span>
<span class=normal><a href=#__codelineno-15-19>19</a></span>
<span class=normal><a href=#__codelineno-15-20>20</a></span>
<span class=normal><a href=#__codelineno-15-21>21</a></span>
<span class=normal><a href=#__codelineno-15-22>22</a></span>
<span class=normal><a href=#__codelineno-15-23>23</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_iam_role&quot;</span><span class=w> </span><span class=nv>&quot;hello_lambda_exec&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2></a><span class=w>  </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;hello-lambda&quot;</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3></a>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4></a><span class=w>  </span><span class=na>assume_role_policy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=dl>POLICY</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5></a><span class=sh>{</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6></a><span class=sh>  &quot;Version&quot;: &quot;2012-10-17&quot;,</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7></a><span class=sh>  &quot;Statement&quot;: [</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8></a><span class=sh>    {</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9></a><span class=sh>      &quot;Effect&quot;: &quot;Allow&quot;,</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10></a><span class=sh>      &quot;Principal&quot;: {</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11></a><span class=sh>        &quot;Service&quot;: &quot;lambda.amazonaws.com&quot;</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12></a><span class=sh>      },</span>
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13></a><span class=sh>      &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span>
</span><span id=__span-15-14><a id=__codelineno-15-14 name=__codelineno-15-14></a><span class=sh>    }</span>
</span><span id=__span-15-15><a id=__codelineno-15-15 name=__codelineno-15-15></a><span class=sh>  ]</span>
</span><span id=__span-15-16><a id=__codelineno-15-16 name=__codelineno-15-16></a><span class=sh>}</span>
</span><span id=__span-15-17><a id=__codelineno-15-17 name=__codelineno-15-17></a><span class=dl>POLICY</span>
</span><span id=__span-15-18><a id=__codelineno-15-18 name=__codelineno-15-18></a><span class=p>}</span>
</span><span id=__span-15-19><a id=__codelineno-15-19 name=__codelineno-15-19></a>
</span><span id=__span-15-20><a id=__codelineno-15-20 name=__codelineno-15-20></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_iam_role_policy_attachment&quot;</span><span class=w> </span><span class=nv>&quot;hello_lambda_policy&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-21><a id=__codelineno-15-21 name=__codelineno-15-21></a><span class=w>  </span><span class=na>role</span><span class=w>       </span><span class=o>=</span><span class=w> </span><span class=nv>aws_iam_role.hello_lambda_exec.name</span>
</span><span id=__span-15-22><a id=__codelineno-15-22 name=__codelineno-15-22></a><span class=w>  </span><span class=na>policy_arn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;</span>
</span><span id=__span-15-23><a id=__codelineno-15-23 name=__codelineno-15-23></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h2 id=criando-uma-funcao-lambda>Criando uma função Lambda<a class=headerlink href=#criando-uma-funcao-lambda title="Permanent link">&para;</a></h2> <p>O próximo recurso será criar a função lambda, a qual chamaremos de "hello". Em seguida especificaremos o nome do intervalo onde armazenaremos todos os lambdas. E nosso key pointing irá apontar para um arquivo zip com uma função.</p> <p>O hash do código-fonte foi adicionado para reimplementar a função caso seja alterado/atualizado algo no código-fonte. Se o hash do arquivo zip for diferente, a reimplantação do lambda será forçada.</p> <div class="tabbed-set tabbed-alternate" data-tabs=8:1><input checked=checked id=__tabbed_8_1 name=__tabbed_8 type=radio><div class=tabbed-labels><label for=__tabbed_8_1><strong>terraform/hello-lambda.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-16-1> 1</a></span>
<span class=normal><a href=#__codelineno-16-2> 2</a></span>
<span class=normal><a href=#__codelineno-16-3> 3</a></span>
<span class=normal><a href=#__codelineno-16-4> 4</a></span>
<span class=normal><a href=#__codelineno-16-5> 5</a></span>
<span class=normal><a href=#__codelineno-16-6> 6</a></span>
<span class=normal><a href=#__codelineno-16-7> 7</a></span>
<span class=normal><a href=#__codelineno-16-8> 8</a></span>
<span class=normal><a href=#__codelineno-16-9> 9</a></span>
<span class=normal><a href=#__codelineno-16-10>10</a></span>
<span class=normal><a href=#__codelineno-16-11>11</a></span>
<span class=normal><a href=#__codelineno-16-12>12</a></span>
<span class=normal><a href=#__codelineno-16-13>13</a></span>
<span class=normal><a href=#__codelineno-16-14>14</a></span>
<span class=normal><a href=#__codelineno-16-15>15</a></span>
<span class=normal><a href=#__codelineno-16-16>16</a></span>
<span class=normal><a href=#__codelineno-16-17>17</a></span>
<span class=normal><a href=#__codelineno-16-18>18</a></span>
<span class=normal><a href=#__codelineno-16-19>19</a></span>
<span class=normal><a href=#__codelineno-16-20>20</a></span>
<span class=normal><a href=#__codelineno-16-21>21</a></span>
<span class=normal><a href=#__codelineno-16-22>22</a></span>
<span class=normal><a href=#__codelineno-16-23>23</a></span>
<span class=normal><a href=#__codelineno-16-24>24</a></span>
<span class=normal><a href=#__codelineno-16-25>25</a></span>
<span class=normal><a href=#__codelineno-16-26>26</a></span>
<span class=normal><a href=#__codelineno-16-27>27</a></span>
<span class=normal><a href=#__codelineno-16-28>28</a></span>
<span class=normal><a href=#__codelineno-16-29>29</a></span>
<span class=normal><a href=#__codelineno-16-30>30</a></span>
<span class=normal><a href=#__codelineno-16-31>31</a></span>
<span class=normal><a href=#__codelineno-16-32>32</a></span>
<span class=normal><a href=#__codelineno-16-33>33</a></span>
<span class=normal><a href=#__codelineno-16-34>34</a></span>
<span class=normal><a href=#__codelineno-16-35>35</a></span>
<span class=normal><a href=#__codelineno-16-36>36</a></span>
<span class=normal><a href=#__codelineno-16-37>37</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_iam_role&quot;</span><span class=w> </span><span class=nv>&quot;hello_lambda_exec&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2></a><span class=w>  </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;hello-lambda&quot;</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3></a>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4></a><span class=w>  </span><span class=na>assume_role_policy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=dl>POLICY</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5></a><span class=sh>{</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6></a><span class=sh>  &quot;Version&quot;: &quot;2012-10-17&quot;,</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7></a><span class=sh>  &quot;Statement&quot;: [</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8></a><span class=sh>    {</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9></a><span class=sh>      &quot;Effect&quot;: &quot;Allow&quot;,</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10></a><span class=sh>      &quot;Principal&quot;: {</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11></a><span class=sh>        &quot;Service&quot;: &quot;lambda.amazonaws.com&quot;</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12></a><span class=sh>      },</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13></a><span class=sh>      &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14></a><span class=sh>    }</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15></a><span class=sh>  ]</span>
</span><span id=__span-16-16><a id=__codelineno-16-16 name=__codelineno-16-16></a><span class=sh>}</span>
</span><span id=__span-16-17><a id=__codelineno-16-17 name=__codelineno-16-17></a><span class=dl>POLICY</span>
</span><span id=__span-16-18><a id=__codelineno-16-18 name=__codelineno-16-18></a><span class=p>}</span>
</span><span id=__span-16-19><a id=__codelineno-16-19 name=__codelineno-16-19></a>
</span><span id=__span-16-20><a id=__codelineno-16-20 name=__codelineno-16-20></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_iam_role_policy_attachment&quot;</span><span class=w> </span><span class=nv>&quot;hello_lambda_policy&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-21><a id=__codelineno-16-21 name=__codelineno-16-21></a><span class=w>  </span><span class=na>role</span><span class=w>       </span><span class=o>=</span><span class=w> </span><span class=nv>aws_iam_role.hello_lambda_exec.name</span>
</span><span id=__span-16-22><a id=__codelineno-16-22 name=__codelineno-16-22></a><span class=w>  </span><span class=na>policy_arn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;</span>
</span><span id=__span-16-23><a id=__codelineno-16-23 name=__codelineno-16-23></a><span class=p>}</span>
</span><span id=__span-16-24><a id=__codelineno-16-24 name=__codelineno-16-24></a>
</span><span id=__span-16-25><a id=__codelineno-16-25 name=__codelineno-16-25></a><span class=err>+</span><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_lambda_function&quot;</span><span class=w> </span><span class=nv>&quot;hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-26><a id=__codelineno-16-26 name=__codelineno-16-26></a><span class=err>+</span><span class=w>  </span><span class=na>function_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;hello&quot;</span>
</span><span id=__span-16-27><a id=__codelineno-16-27 name=__codelineno-16-27></a>
</span><span id=__span-16-28><a id=__codelineno-16-28 name=__codelineno-16-28></a><span class=err>+</span><span class=w>  </span><span class=na>s3_bucket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_bucket.lambda_bucket.id</span>
</span><span id=__span-16-29><a id=__codelineno-16-29 name=__codelineno-16-29></a><span class=err>+</span><span class=w>  </span><span class=na>s3_key</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_object.lambda_hello.key</span>
</span><span id=__span-16-30><a id=__codelineno-16-30 name=__codelineno-16-30></a>
</span><span id=__span-16-31><a id=__codelineno-16-31 name=__codelineno-16-31></a><span class=err>+</span><span class=w>  </span><span class=na>runtime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;nodejs16.x&quot;</span>
</span><span id=__span-16-32><a id=__codelineno-16-32 name=__codelineno-16-32></a><span class=err>+</span><span class=w>  </span><span class=na>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;function.handler&quot;</span>
</span><span id=__span-16-33><a id=__codelineno-16-33 name=__codelineno-16-33></a>
</span><span id=__span-16-34><a id=__codelineno-16-34 name=__codelineno-16-34></a><span class=err>+</span><span class=w>  </span><span class=na>source_code_hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>data.archive_file.lambda_hello.output_base64sha256</span>
</span><span id=__span-16-35><a id=__codelineno-16-35 name=__codelineno-16-35></a>
</span><span id=__span-16-36><a id=__codelineno-16-36 name=__codelineno-16-36></a><span class=err>+</span><span class=w>  </span><span class=na>role</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_iam_role.hello_lambda_exec.arn</span>
</span><span id=__span-16-37><a id=__codelineno-16-37 name=__codelineno-16-37></a><span class=err>+</span><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h2 id=criando-o-cloudwatch>Criando o CloudWatch<a class=headerlink href=#criando-o-cloudwatch title="Permanent link">&para;</a></h2> <p>O CloudWatch é um serviço de <strong>monitoramento e observabilidade</strong> oferecido pela AWS. Ele permite que você <strong>colete e monitore métricas, registros e eventos de diferentes recursos e serviços da AWS, fornecendo insights valiosos sobre o desempenho, a saúde e a disponibilidade do seu ambiente de nuvem.</strong> Com o CloudWatch, você pode definir alarmes para acionar ações automáticas, criar painéis personalizados para visualizar dados em tempo real, além de acessar informações históricas para análise e solução de problemas. Ele é uma ferramenta fundamental para garantir o <strong>monitoramento proativo e a operação eficiente dos seus recursos na nuvem da AWS.</strong></p> <p>Para depurar, criamos um grupo de logs do CloudWatch que conseguisse armazenar todas as instruções e erros do console.log na função. Definimos a retenção para 30 dias, porém poderia ser uma quantidade maior ou menor também, a depender das intenções de quem está desenvolvendo a infraestrutura (além dessas decisões poderem afetar o custo de execução do lambda).</p> <div class="tabbed-set tabbed-alternate" data-tabs=9:1><input checked=checked id=__tabbed_9_1 name=__tabbed_9 type=radio><div class=tabbed-labels><label for=__tabbed_9_1><strong>terraform/hello-lambda.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-17-1> 1</a></span>
<span class=normal><a href=#__codelineno-17-2> 2</a></span>
<span class=normal><a href=#__codelineno-17-3> 3</a></span>
<span class=normal><a href=#__codelineno-17-4> 4</a></span>
<span class=normal><a href=#__codelineno-17-5> 5</a></span>
<span class=normal><a href=#__codelineno-17-6> 6</a></span>
<span class=normal><a href=#__codelineno-17-7> 7</a></span>
<span class=normal><a href=#__codelineno-17-8> 8</a></span>
<span class=normal><a href=#__codelineno-17-9> 9</a></span>
<span class=normal><a href=#__codelineno-17-10>10</a></span>
<span class=normal><a href=#__codelineno-17-11>11</a></span>
<span class=normal><a href=#__codelineno-17-12>12</a></span>
<span class=normal><a href=#__codelineno-17-13>13</a></span>
<span class=normal><a href=#__codelineno-17-14>14</a></span>
<span class=normal><a href=#__codelineno-17-15>15</a></span>
<span class=normal><a href=#__codelineno-17-16>16</a></span>
<span class=normal><a href=#__codelineno-17-17>17</a></span>
<span class=normal><a href=#__codelineno-17-18>18</a></span>
<span class=normal><a href=#__codelineno-17-19>19</a></span>
<span class=normal><a href=#__codelineno-17-20>20</a></span>
<span class=normal><a href=#__codelineno-17-21>21</a></span>
<span class=normal><a href=#__codelineno-17-22>22</a></span>
<span class=normal><a href=#__codelineno-17-23>23</a></span>
<span class=normal><a href=#__codelineno-17-24>24</a></span>
<span class=normal><a href=#__codelineno-17-25>25</a></span>
<span class=normal><a href=#__codelineno-17-26>26</a></span>
<span class=normal><a href=#__codelineno-17-27>27</a></span>
<span class=normal><a href=#__codelineno-17-28>28</a></span>
<span class=normal><a href=#__codelineno-17-29>29</a></span>
<span class=normal><a href=#__codelineno-17-30>30</a></span>
<span class=normal><a href=#__codelineno-17-31>31</a></span>
<span class=normal><a href=#__codelineno-17-32>32</a></span>
<span class=normal><a href=#__codelineno-17-33>33</a></span>
<span class=normal><a href=#__codelineno-17-34>34</a></span>
<span class=normal><a href=#__codelineno-17-35>35</a></span>
<span class=normal><a href=#__codelineno-17-36>36</a></span>
<span class=normal><a href=#__codelineno-17-37>37</a></span>
<span class=normal><a href=#__codelineno-17-38>38</a></span>
<span class=normal><a href=#__codelineno-17-39>39</a></span>
<span class=normal><a href=#__codelineno-17-40>40</a></span>
<span class=normal><a href=#__codelineno-17-41>41</a></span>
<span class=normal><a href=#__codelineno-17-42>42</a></span>
<span class=normal><a href=#__codelineno-17-43>43</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_iam_role&quot;</span><span class=w> </span><span class=nv>&quot;hello_lambda_exec&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2></a><span class=w>  </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;hello-lambda&quot;</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3></a>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4></a><span class=w>  </span><span class=na>assume_role_policy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=dl>POLICY</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5></a><span class=sh>{</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6></a><span class=sh>  &quot;Version&quot;: &quot;2012-10-17&quot;,</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7></a><span class=sh>  &quot;Statement&quot;: [</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8></a><span class=sh>    {</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9></a><span class=sh>      &quot;Effect&quot;: &quot;Allow&quot;,</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10></a><span class=sh>      &quot;Principal&quot;: {</span>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11></a><span class=sh>        &quot;Service&quot;: &quot;lambda.amazonaws.com&quot;</span>
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12></a><span class=sh>      },</span>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13></a><span class=sh>      &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span>
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14></a><span class=sh>    }</span>
</span><span id=__span-17-15><a id=__codelineno-17-15 name=__codelineno-17-15></a><span class=sh>  ]</span>
</span><span id=__span-17-16><a id=__codelineno-17-16 name=__codelineno-17-16></a><span class=sh>}</span>
</span><span id=__span-17-17><a id=__codelineno-17-17 name=__codelineno-17-17></a><span class=dl>POLICY</span>
</span><span id=__span-17-18><a id=__codelineno-17-18 name=__codelineno-17-18></a><span class=p>}</span>
</span><span id=__span-17-19><a id=__codelineno-17-19 name=__codelineno-17-19></a>
</span><span id=__span-17-20><a id=__codelineno-17-20 name=__codelineno-17-20></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_iam_role_policy_attachment&quot;</span><span class=w> </span><span class=nv>&quot;hello_lambda_policy&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-21><a id=__codelineno-17-21 name=__codelineno-17-21></a><span class=w>  </span><span class=na>role</span><span class=w>       </span><span class=o>=</span><span class=w> </span><span class=nv>aws_iam_role.hello_lambda_exec.name</span>
</span><span id=__span-17-22><a id=__codelineno-17-22 name=__codelineno-17-22></a><span class=w>  </span><span class=na>policy_arn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;</span>
</span><span id=__span-17-23><a id=__codelineno-17-23 name=__codelineno-17-23></a><span class=p>}</span>
</span><span id=__span-17-24><a id=__codelineno-17-24 name=__codelineno-17-24></a>
</span><span id=__span-17-25><a id=__codelineno-17-25 name=__codelineno-17-25></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_lambda_function&quot;</span><span class=w> </span><span class=nv>&quot;hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-26><a id=__codelineno-17-26 name=__codelineno-17-26></a><span class=w>  </span><span class=na>function_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;hello&quot;</span>
</span><span id=__span-17-27><a id=__codelineno-17-27 name=__codelineno-17-27></a>
</span><span id=__span-17-28><a id=__codelineno-17-28 name=__codelineno-17-28></a><span class=w>  </span><span class=na>s3_bucket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_bucket.lambda_bucket.id</span>
</span><span id=__span-17-29><a id=__codelineno-17-29 name=__codelineno-17-29></a><span class=w>  </span><span class=na>s3_key</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_object.lambda_hello.key</span>
</span><span id=__span-17-30><a id=__codelineno-17-30 name=__codelineno-17-30></a>
</span><span id=__span-17-31><a id=__codelineno-17-31 name=__codelineno-17-31></a><span class=w>  </span><span class=na>runtime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;nodejs16.x&quot;</span>
</span><span id=__span-17-32><a id=__codelineno-17-32 name=__codelineno-17-32></a><span class=w>  </span><span class=na>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;function.handler&quot;</span>
</span><span id=__span-17-33><a id=__codelineno-17-33 name=__codelineno-17-33></a>
</span><span id=__span-17-34><a id=__codelineno-17-34 name=__codelineno-17-34></a><span class=w>  </span><span class=na>source_code_hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>data.archive_file.lambda_hello.output_base64sha256</span>
</span><span id=__span-17-35><a id=__codelineno-17-35 name=__codelineno-17-35></a>
</span><span id=__span-17-36><a id=__codelineno-17-36 name=__codelineno-17-36></a><span class=w>  </span><span class=na>role</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_iam_role.hello_lambda_exec.arn</span>
</span><span id=__span-17-37><a id=__codelineno-17-37 name=__codelineno-17-37></a><span class=p>}</span>
</span><span id=__span-17-38><a id=__codelineno-17-38 name=__codelineno-17-38></a>
</span><span id=__span-17-39><a id=__codelineno-17-39 name=__codelineno-17-39></a><span class=err>+</span><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_cloudwatch_log_group&quot;</span><span class=w> </span><span class=nv>&quot;hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-40><a id=__codelineno-17-40 name=__codelineno-17-40></a><span class=err>+</span><span class=w>  </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;/aws/lambda/${aws_lambda_function.hello.function_name}&quot;</span>
</span><span id=__span-17-41><a id=__codelineno-17-41 name=__codelineno-17-41></a>
</span><span id=__span-17-42><a id=__codelineno-17-42 name=__codelineno-17-42></a><span class=err>+</span><span class=w>  </span><span class=na>retention_in_days</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>30</span>
</span><span id=__span-17-43><a id=__codelineno-17-43 name=__codelineno-17-43></a><span class=err>+</span><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Em seguida, adicionaremos o recurso que empacota o lambda como um arquivo zip.</p> <div class="tabbed-set tabbed-alternate" data-tabs=10:1><input checked=checked id=__tabbed_10_1 name=__tabbed_10 type=radio><div class=tabbed-labels><label for=__tabbed_10_1><strong>terraform/hello-lambda.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-18-1> 1</a></span>
<span class=normal><a href=#__codelineno-18-2> 2</a></span>
<span class=normal><a href=#__codelineno-18-3> 3</a></span>
<span class=normal><a href=#__codelineno-18-4> 4</a></span>
<span class=normal><a href=#__codelineno-18-5> 5</a></span>
<span class=normal><a href=#__codelineno-18-6> 6</a></span>
<span class=normal><a href=#__codelineno-18-7> 7</a></span>
<span class=normal><a href=#__codelineno-18-8> 8</a></span>
<span class=normal><a href=#__codelineno-18-9> 9</a></span>
<span class=normal><a href=#__codelineno-18-10>10</a></span>
<span class=normal><a href=#__codelineno-18-11>11</a></span>
<span class=normal><a href=#__codelineno-18-12>12</a></span>
<span class=normal><a href=#__codelineno-18-13>13</a></span>
<span class=normal><a href=#__codelineno-18-14>14</a></span>
<span class=normal><a href=#__codelineno-18-15>15</a></span>
<span class=normal><a href=#__codelineno-18-16>16</a></span>
<span class=normal><a href=#__codelineno-18-17>17</a></span>
<span class=normal><a href=#__codelineno-18-18>18</a></span>
<span class=normal><a href=#__codelineno-18-19>19</a></span>
<span class=normal><a href=#__codelineno-18-20>20</a></span>
<span class=normal><a href=#__codelineno-18-21>21</a></span>
<span class=normal><a href=#__codelineno-18-22>22</a></span>
<span class=normal><a href=#__codelineno-18-23>23</a></span>
<span class=normal><a href=#__codelineno-18-24>24</a></span>
<span class=normal><a href=#__codelineno-18-25>25</a></span>
<span class=normal><a href=#__codelineno-18-26>26</a></span>
<span class=normal><a href=#__codelineno-18-27>27</a></span>
<span class=normal><a href=#__codelineno-18-28>28</a></span>
<span class=normal><a href=#__codelineno-18-29>29</a></span>
<span class=normal><a href=#__codelineno-18-30>30</a></span>
<span class=normal><a href=#__codelineno-18-31>31</a></span>
<span class=normal><a href=#__codelineno-18-32>32</a></span>
<span class=normal><a href=#__codelineno-18-33>33</a></span>
<span class=normal><a href=#__codelineno-18-34>34</a></span>
<span class=normal><a href=#__codelineno-18-35>35</a></span>
<span class=normal><a href=#__codelineno-18-36>36</a></span>
<span class=normal><a href=#__codelineno-18-37>37</a></span>
<span class=normal><a href=#__codelineno-18-38>38</a></span>
<span class=normal><a href=#__codelineno-18-39>39</a></span>
<span class=normal><a href=#__codelineno-18-40>40</a></span>
<span class=normal><a href=#__codelineno-18-41>41</a></span>
<span class=normal><a href=#__codelineno-18-42>42</a></span>
<span class=normal><a href=#__codelineno-18-43>43</a></span>
<span class=normal><a href=#__codelineno-18-44>44</a></span>
<span class=normal><a href=#__codelineno-18-45>45</a></span>
<span class=normal><a href=#__codelineno-18-46>46</a></span>
<span class=normal><a href=#__codelineno-18-47>47</a></span>
<span class=normal><a href=#__codelineno-18-48>48</a></span>
<span class=normal><a href=#__codelineno-18-49>49</a></span>
<span class=normal><a href=#__codelineno-18-50>50</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_iam_role&quot;</span><span class=w> </span><span class=nv>&quot;hello_lambda_exec&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2></a><span class=w>  </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;hello-lambda&quot;</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3></a>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4></a><span class=w>  </span><span class=na>assume_role_policy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=dl>POLICY</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5></a><span class=sh>{</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6></a><span class=sh>  &quot;Version&quot;: &quot;2012-10-17&quot;,</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7></a><span class=sh>  &quot;Statement&quot;: [</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8></a><span class=sh>    {</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9></a><span class=sh>      &quot;Effect&quot;: &quot;Allow&quot;,</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10></a><span class=sh>      &quot;Principal&quot;: {</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11></a><span class=sh>        &quot;Service&quot;: &quot;lambda.amazonaws.com&quot;</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12></a><span class=sh>      },</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13></a><span class=sh>      &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14></a><span class=sh>    }</span>
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15></a><span class=sh>  ]</span>
</span><span id=__span-18-16><a id=__codelineno-18-16 name=__codelineno-18-16></a><span class=sh>}</span>
</span><span id=__span-18-17><a id=__codelineno-18-17 name=__codelineno-18-17></a><span class=dl>POLICY</span>
</span><span id=__span-18-18><a id=__codelineno-18-18 name=__codelineno-18-18></a><span class=p>}</span>
</span><span id=__span-18-19><a id=__codelineno-18-19 name=__codelineno-18-19></a>
</span><span id=__span-18-20><a id=__codelineno-18-20 name=__codelineno-18-20></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_iam_role_policy_attachment&quot;</span><span class=w> </span><span class=nv>&quot;hello_lambda_policy&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-21><a id=__codelineno-18-21 name=__codelineno-18-21></a><span class=w>  </span><span class=na>role</span><span class=w>       </span><span class=o>=</span><span class=w> </span><span class=nv>aws_iam_role.hello_lambda_exec.name</span>
</span><span id=__span-18-22><a id=__codelineno-18-22 name=__codelineno-18-22></a><span class=w>  </span><span class=na>policy_arn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;</span>
</span><span id=__span-18-23><a id=__codelineno-18-23 name=__codelineno-18-23></a><span class=p>}</span>
</span><span id=__span-18-24><a id=__codelineno-18-24 name=__codelineno-18-24></a>
</span><span id=__span-18-25><a id=__codelineno-18-25 name=__codelineno-18-25></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_lambda_function&quot;</span><span class=w> </span><span class=nv>&quot;hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-26><a id=__codelineno-18-26 name=__codelineno-18-26></a><span class=w>  </span><span class=na>function_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;hello&quot;</span>
</span><span id=__span-18-27><a id=__codelineno-18-27 name=__codelineno-18-27></a>
</span><span id=__span-18-28><a id=__codelineno-18-28 name=__codelineno-18-28></a><span class=w>  </span><span class=na>s3_bucket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_bucket.lambda_bucket.id</span>
</span><span id=__span-18-29><a id=__codelineno-18-29 name=__codelineno-18-29></a><span class=w>  </span><span class=na>s3_key</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_object.lambda_hello.key</span>
</span><span id=__span-18-30><a id=__codelineno-18-30 name=__codelineno-18-30></a>
</span><span id=__span-18-31><a id=__codelineno-18-31 name=__codelineno-18-31></a><span class=w>  </span><span class=na>runtime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;nodejs16.x&quot;</span>
</span><span id=__span-18-32><a id=__codelineno-18-32 name=__codelineno-18-32></a><span class=w>  </span><span class=na>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;function.handler&quot;</span>
</span><span id=__span-18-33><a id=__codelineno-18-33 name=__codelineno-18-33></a>
</span><span id=__span-18-34><a id=__codelineno-18-34 name=__codelineno-18-34></a><span class=w>  </span><span class=na>source_code_hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>data.archive_file.lambda_hello.output_base64sha256</span>
</span><span id=__span-18-35><a id=__codelineno-18-35 name=__codelineno-18-35></a>
</span><span id=__span-18-36><a id=__codelineno-18-36 name=__codelineno-18-36></a><span class=w>  </span><span class=na>role</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_iam_role.hello_lambda_exec.arn</span>
</span><span id=__span-18-37><a id=__codelineno-18-37 name=__codelineno-18-37></a><span class=p>}</span>
</span><span id=__span-18-38><a id=__codelineno-18-38 name=__codelineno-18-38></a>
</span><span id=__span-18-39><a id=__codelineno-18-39 name=__codelineno-18-39></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_cloudwatch_log_group&quot;</span><span class=w> </span><span class=nv>&quot;hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-40><a id=__codelineno-18-40 name=__codelineno-18-40></a><span class=w>  </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;/aws/lambda/${aws_lambda_function.hello.function_name}&quot;</span>
</span><span id=__span-18-41><a id=__codelineno-18-41 name=__codelineno-18-41></a>
</span><span id=__span-18-42><a id=__codelineno-18-42 name=__codelineno-18-42></a><span class=w>  </span><span class=na>retention_in_days</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>14</span>
</span><span id=__span-18-43><a id=__codelineno-18-43 name=__codelineno-18-43></a><span class=p>}</span>
</span><span id=__span-18-44><a id=__codelineno-18-44 name=__codelineno-18-44></a>
</span><span id=__span-18-45><a id=__codelineno-18-45 name=__codelineno-18-45></a><span class=err>+</span><span class=kr>data</span><span class=w> </span><span class=nc>&quot;archive_file&quot;</span><span class=w> </span><span class=nv>&quot;lambda_hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-46><a id=__codelineno-18-46 name=__codelineno-18-46></a><span class=err>+</span><span class=w>  </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;zip&quot;</span>
</span><span id=__span-18-47><a id=__codelineno-18-47 name=__codelineno-18-47></a>
</span><span id=__span-18-48><a id=__codelineno-18-48 name=__codelineno-18-48></a><span class=err>+</span><span class=w>  </span><span class=na>source_dir</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;../${path.module}/hello&quot;</span>
</span><span id=__span-18-49><a id=__codelineno-18-49 name=__codelineno-18-49></a><span class=err>+</span><span class=w>  </span><span class=na>output_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;../${path.module}/hello.zip&quot;</span>
</span><span id=__span-18-50><a id=__codelineno-18-50 name=__codelineno-18-50></a><span class=err>+</span><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Nosso último componente visa obter o arquivo zip e carregar no bucket do S3.</p> <div class="tabbed-set tabbed-alternate" data-tabs=11:1><input checked=checked id=__tabbed_11_1 name=__tabbed_11 type=radio><div class=tabbed-labels><label for=__tabbed_11_1><strong>terraform/hello-lambda.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-19-1> 1</a></span>
<span class=normal><a href=#__codelineno-19-2> 2</a></span>
<span class=normal><a href=#__codelineno-19-3> 3</a></span>
<span class=normal><a href=#__codelineno-19-4> 4</a></span>
<span class=normal><a href=#__codelineno-19-5> 5</a></span>
<span class=normal><a href=#__codelineno-19-6> 6</a></span>
<span class=normal><a href=#__codelineno-19-7> 7</a></span>
<span class=normal><a href=#__codelineno-19-8> 8</a></span>
<span class=normal><a href=#__codelineno-19-9> 9</a></span>
<span class=normal><a href=#__codelineno-19-10>10</a></span>
<span class=normal><a href=#__codelineno-19-11>11</a></span>
<span class=normal><a href=#__codelineno-19-12>12</a></span>
<span class=normal><a href=#__codelineno-19-13>13</a></span>
<span class=normal><a href=#__codelineno-19-14>14</a></span>
<span class=normal><a href=#__codelineno-19-15>15</a></span>
<span class=normal><a href=#__codelineno-19-16>16</a></span>
<span class=normal><a href=#__codelineno-19-17>17</a></span>
<span class=normal><a href=#__codelineno-19-18>18</a></span>
<span class=normal><a href=#__codelineno-19-19>19</a></span>
<span class=normal><a href=#__codelineno-19-20>20</a></span>
<span class=normal><a href=#__codelineno-19-21>21</a></span>
<span class=normal><a href=#__codelineno-19-22>22</a></span>
<span class=normal><a href=#__codelineno-19-23>23</a></span>
<span class=normal><a href=#__codelineno-19-24>24</a></span>
<span class=normal><a href=#__codelineno-19-25>25</a></span>
<span class=normal><a href=#__codelineno-19-26>26</a></span>
<span class=normal><a href=#__codelineno-19-27>27</a></span>
<span class=normal><a href=#__codelineno-19-28>28</a></span>
<span class=normal><a href=#__codelineno-19-29>29</a></span>
<span class=normal><a href=#__codelineno-19-30>30</a></span>
<span class=normal><a href=#__codelineno-19-31>31</a></span>
<span class=normal><a href=#__codelineno-19-32>32</a></span>
<span class=normal><a href=#__codelineno-19-33>33</a></span>
<span class=normal><a href=#__codelineno-19-34>34</a></span>
<span class=normal><a href=#__codelineno-19-35>35</a></span>
<span class=normal><a href=#__codelineno-19-36>36</a></span>
<span class=normal><a href=#__codelineno-19-37>37</a></span>
<span class=normal><a href=#__codelineno-19-38>38</a></span>
<span class=normal><a href=#__codelineno-19-39>39</a></span>
<span class=normal><a href=#__codelineno-19-40>40</a></span>
<span class=normal><a href=#__codelineno-19-41>41</a></span>
<span class=normal><a href=#__codelineno-19-42>42</a></span>
<span class=normal><a href=#__codelineno-19-43>43</a></span>
<span class=normal><a href=#__codelineno-19-44>44</a></span>
<span class=normal><a href=#__codelineno-19-45>45</a></span>
<span class=normal><a href=#__codelineno-19-46>46</a></span>
<span class=normal><a href=#__codelineno-19-47>47</a></span>
<span class=normal><a href=#__codelineno-19-48>48</a></span>
<span class=normal><a href=#__codelineno-19-49>49</a></span>
<span class=normal><a href=#__codelineno-19-50>50</a></span>
<span class=normal><a href=#__codelineno-19-51>51</a></span>
<span class=normal><a href=#__codelineno-19-52>52</a></span>
<span class=normal><a href=#__codelineno-19-53>53</a></span>
<span class=normal><a href=#__codelineno-19-54>54</a></span>
<span class=normal><a href=#__codelineno-19-55>55</a></span>
<span class=normal><a href=#__codelineno-19-56>56</a></span>
<span class=normal><a href=#__codelineno-19-57>57</a></span>
<span class=normal><a href=#__codelineno-19-58>58</a></span>
<span class=normal><a href=#__codelineno-19-59>59</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_iam_role&quot;</span><span class=w> </span><span class=nv>&quot;hello_lambda_exec&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2></a><span class=w>  </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;hello-lambda&quot;</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3></a>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4></a><span class=w>  </span><span class=na>assume_role_policy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=dl>POLICY</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5></a><span class=sh>{</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6></a><span class=sh>  &quot;Version&quot;: &quot;2012-10-17&quot;,</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7></a><span class=sh>  &quot;Statement&quot;: [</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8></a><span class=sh>    {</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9></a><span class=sh>      &quot;Effect&quot;: &quot;Allow&quot;,</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10></a><span class=sh>      &quot;Principal&quot;: {</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11></a><span class=sh>        &quot;Service&quot;: &quot;lambda.amazonaws.com&quot;</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12></a><span class=sh>      },</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13></a><span class=sh>      &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14></a><span class=sh>    }</span>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15></a><span class=sh>  ]</span>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16></a><span class=sh>}</span>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17></a><span class=dl>POLICY</span>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18></a><span class=p>}</span>
</span><span id=__span-19-19><a id=__codelineno-19-19 name=__codelineno-19-19></a>
</span><span id=__span-19-20><a id=__codelineno-19-20 name=__codelineno-19-20></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_iam_role_policy_attachment&quot;</span><span class=w> </span><span class=nv>&quot;hello_lambda_policy&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-21><a id=__codelineno-19-21 name=__codelineno-19-21></a><span class=w>  </span><span class=na>role</span><span class=w>       </span><span class=o>=</span><span class=w> </span><span class=nv>aws_iam_role.hello_lambda_exec.name</span>
</span><span id=__span-19-22><a id=__codelineno-19-22 name=__codelineno-19-22></a><span class=w>  </span><span class=na>policy_arn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;</span>
</span><span id=__span-19-23><a id=__codelineno-19-23 name=__codelineno-19-23></a><span class=p>}</span>
</span><span id=__span-19-24><a id=__codelineno-19-24 name=__codelineno-19-24></a>
</span><span id=__span-19-25><a id=__codelineno-19-25 name=__codelineno-19-25></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_lambda_function&quot;</span><span class=w> </span><span class=nv>&quot;hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-26><a id=__codelineno-19-26 name=__codelineno-19-26></a><span class=w>  </span><span class=na>function_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;hello&quot;</span>
</span><span id=__span-19-27><a id=__codelineno-19-27 name=__codelineno-19-27></a>
</span><span id=__span-19-28><a id=__codelineno-19-28 name=__codelineno-19-28></a><span class=w>  </span><span class=na>s3_bucket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_bucket.lambda_bucket.id</span>
</span><span id=__span-19-29><a id=__codelineno-19-29 name=__codelineno-19-29></a><span class=w>  </span><span class=na>s3_key</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_object.lambda_hello.key</span>
</span><span id=__span-19-30><a id=__codelineno-19-30 name=__codelineno-19-30></a>
</span><span id=__span-19-31><a id=__codelineno-19-31 name=__codelineno-19-31></a><span class=w>  </span><span class=na>runtime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;nodejs16.x&quot;</span>
</span><span id=__span-19-32><a id=__codelineno-19-32 name=__codelineno-19-32></a><span class=w>  </span><span class=na>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;function.handler&quot;</span>
</span><span id=__span-19-33><a id=__codelineno-19-33 name=__codelineno-19-33></a>
</span><span id=__span-19-34><a id=__codelineno-19-34 name=__codelineno-19-34></a><span class=w>  </span><span class=na>source_code_hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>data.archive_file.lambda_hello.output_base64sha256</span>
</span><span id=__span-19-35><a id=__codelineno-19-35 name=__codelineno-19-35></a>
</span><span id=__span-19-36><a id=__codelineno-19-36 name=__codelineno-19-36></a><span class=w>  </span><span class=na>role</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_iam_role.hello_lambda_exec.arn</span>
</span><span id=__span-19-37><a id=__codelineno-19-37 name=__codelineno-19-37></a><span class=p>}</span>
</span><span id=__span-19-38><a id=__codelineno-19-38 name=__codelineno-19-38></a>
</span><span id=__span-19-39><a id=__codelineno-19-39 name=__codelineno-19-39></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_cloudwatch_log_group&quot;</span><span class=w> </span><span class=nv>&quot;hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-40><a id=__codelineno-19-40 name=__codelineno-19-40></a><span class=w>  </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;/aws/lambda/${aws_lambda_function.hello.function_name}&quot;</span>
</span><span id=__span-19-41><a id=__codelineno-19-41 name=__codelineno-19-41></a>
</span><span id=__span-19-42><a id=__codelineno-19-42 name=__codelineno-19-42></a><span class=w>  </span><span class=na>retention_in_days</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>30</span>
</span><span id=__span-19-43><a id=__codelineno-19-43 name=__codelineno-19-43></a><span class=p>}</span>
</span><span id=__span-19-44><a id=__codelineno-19-44 name=__codelineno-19-44></a>
</span><span id=__span-19-45><a id=__codelineno-19-45 name=__codelineno-19-45></a><span class=kr>data</span><span class=w> </span><span class=nc>&quot;archive_file&quot;</span><span class=w> </span><span class=nv>&quot;lambda_hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-46><a id=__codelineno-19-46 name=__codelineno-19-46></a><span class=w>  </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;zip&quot;</span>
</span><span id=__span-19-47><a id=__codelineno-19-47 name=__codelineno-19-47></a>
</span><span id=__span-19-48><a id=__codelineno-19-48 name=__codelineno-19-48></a><span class=w>  </span><span class=na>source_dir</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;../${path.module}/hello&quot;</span>
</span><span id=__span-19-49><a id=__codelineno-19-49 name=__codelineno-19-49></a><span class=w>  </span><span class=na>output_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;../${path.module}/hello.zip&quot;</span>
</span><span id=__span-19-50><a id=__codelineno-19-50 name=__codelineno-19-50></a><span class=p>}</span>
</span><span id=__span-19-51><a id=__codelineno-19-51 name=__codelineno-19-51></a>
</span><span id=__span-19-52><a id=__codelineno-19-52 name=__codelineno-19-52></a><span class=err>+</span><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_s3_object&quot;</span><span class=w> </span><span class=nv>&quot;lambda_hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-53><a id=__codelineno-19-53 name=__codelineno-19-53></a><span class=err>+</span><span class=w>  </span><span class=na>bucket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_bucket.lambda_bucket.id</span>
</span><span id=__span-19-54><a id=__codelineno-19-54 name=__codelineno-19-54></a>
</span><span id=__span-19-55><a id=__codelineno-19-55 name=__codelineno-19-55></a><span class=err>+</span><span class=w>  </span><span class=na>key</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;hello.zip&quot;</span>
</span><span id=__span-19-56><a id=__codelineno-19-56 name=__codelineno-19-56></a><span class=err>+</span><span class=w>  </span><span class=na>source</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>data.archive_file.lambda_hello.output_path</span>
</span><span id=__span-19-57><a id=__codelineno-19-57 name=__codelineno-19-57></a>
</span><span id=__span-19-58><a id=__codelineno-19-58 name=__codelineno-19-58></a><span class=err>+</span><span class=w>  </span><span class=na>etag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>filemd5</span><span class=p>(</span><span class=nv>data.archive_file.lambda_hello.output_path</span><span class=p>)</span>
</span><span id=__span-19-59><a id=__codelineno-19-59 name=__codelineno-19-59></a><span class=err>+</span><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h2 id=inicializando-o-terraform>Inicializando o Terraform<a class=headerlink href=#inicializando-o-terraform title="Permanent link">&para;</a></h2> <p>Com os passos feitos até aqui já conseguimos inicializar o terraform:</p> <div class="language-tf highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=err>terraform</span><span class=w> </span><span class=err>init</span>
</span></code></pre></div> <p><img alt=terraforminit src=screenshots/001.png></p> <p>Agora aplicamos as alterações:</p> <div class="language-tf highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=err>terraform</span><span class=w> </span><span class=err>apply</span>
</span></code></pre></div> <p><img alt=terraforminit src=screenshots/002.png></p> <blockquote> <p><img alt=⚠ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/26a0.svg title=:warning:> <strong>Dica visual</strong></p> <p>Quando o terraform concluir suas etapas até aqui, podemos entrar no dashboard da AWS e encontrar, dentre outras coisas, um bucket S3 recém-criado com um nome definido por meio de um gerador de animais de estimação aleatório. <img alt=terraforminit src=screenshots/003.png> &gt; <img alt=terraforminit src=screenshots/004.png></p> </blockquote> <hr> <p><strong>Para abstrair:</strong></p> <p>Note que dentro do bucket são armazenadas funções lambdas dentro de um <strong>zip.</strong></p> <p>Quando entramos na dashboard da <strong>AWS CloudWatch</strong> também conseguimos ver o grupo de logs criado.</p> <p><img alt=terraforminit src=screenshots/005.png></p> <p>No dashboard do <strong>AWS Lambda</strong> conseguimos ver a função lambda empacotada como um zip.</p> <p><img alt=terraforminit src=screenshots/006.png></p> <hr> <p>Vamos agora invocar a função com o comando <strong><em>aws lambda invoke</em></strong>.</p> <p>Lembre-se de especificar ou conferir se o nome da região, função e arquivo estão corretos para registrar a resposta da função.</p> <div class="language-tf highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=err>aws</span><span class=w> </span><span class=err>lambda</span><span class=w> </span><span class=err>invoke</span><span class=w> </span><span class=na>--region</span><span class=o>=</span><span class=err>us-east-</span><span class=m>1</span><span class=w> </span><span class=na>--function-name</span><span class=o>=</span><span class=err>hello</span><span class=w> </span><span class=nv>response.json</span>
</span></code></pre></div> <p><img alt=terraforminit src=screenshots/007.png></p> <p>Ao printarmos a resposta, é esperado um retorno <strong>"Olá, Avelino!"</strong></p> <div class="language-tf highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=err>cat</span><span class=w> </span><span class=nv>response.json</span>
</span></code></pre></div> <p><img alt=terraforminit src=screenshots/008.png></p> <h2 id=criando-o-api-gateway>Criando o API Gateway<a class=headerlink href=#criando-o-api-gateway title="Permanent link">&para;</a></h2> <p>A próxima estapa será criar o API Gateway e integrá-lo ao nosso lambda.</p> <p>O API Gateway é um serviço da AWS que permite <strong>criar, publicar, proteger e gerenciar APIs (Interfaces de Programação de Aplicativos).</strong> Ele atua como um ponto de entrada para os aplicativos acessarem funcionalidades e dados, fornecendo recursos como <strong>autenticação, autorização, limitação de taxa e transformação de dados.</strong> O API Gateway simplifica o processo de criação de APIs, permitindo que você se concentre na lógica do aplicativo, enquanto ele gerencia aspectos como escalabilidade, segurança e monitoramento. Com o API Gateway, é possível <strong>criar APIs RESTful ou WebSocket para integrar e expor seus serviços e recursos de forma segura na nuvem da AWS.</strong></p> <div class="tabbed-set tabbed-alternate" data-tabs=12:1><input checked=checked id=__tabbed_12_1 name=__tabbed_12 type=radio><div class=tabbed-labels><label for=__tabbed_12_1><strong>terraform/api-gateway.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-24-1> 1</a></span>
<span class=normal><a href=#__codelineno-24-2> 2</a></span>
<span class=normal><a href=#__codelineno-24-3> 3</a></span>
<span class=normal><a href=#__codelineno-24-4> 4</a></span>
<span class=normal><a href=#__codelineno-24-5> 5</a></span>
<span class=normal><a href=#__codelineno-24-6> 6</a></span>
<span class=normal><a href=#__codelineno-24-7> 7</a></span>
<span class=normal><a href=#__codelineno-24-8> 8</a></span>
<span class=normal><a href=#__codelineno-24-9> 9</a></span>
<span class=normal><a href=#__codelineno-24-10>10</a></span>
<span class=normal><a href=#__codelineno-24-11>11</a></span>
<span class=normal><a href=#__codelineno-24-12>12</a></span>
<span class=normal><a href=#__codelineno-24-13>13</a></span>
<span class=normal><a href=#__codelineno-24-14>14</a></span>
<span class=normal><a href=#__codelineno-24-15>15</a></span>
<span class=normal><a href=#__codelineno-24-16>16</a></span>
<span class=normal><a href=#__codelineno-24-17>17</a></span>
<span class=normal><a href=#__codelineno-24-18>18</a></span>
<span class=normal><a href=#__codelineno-24-19>19</a></span>
<span class=normal><a href=#__codelineno-24-20>20</a></span>
<span class=normal><a href=#__codelineno-24-21>21</a></span>
<span class=normal><a href=#__codelineno-24-22>22</a></span>
<span class=normal><a href=#__codelineno-24-23>23</a></span>
<span class=normal><a href=#__codelineno-24-24>24</a></span>
<span class=normal><a href=#__codelineno-24-25>25</a></span>
<span class=normal><a href=#__codelineno-24-26>26</a></span>
<span class=normal><a href=#__codelineno-24-27>27</a></span>
<span class=normal><a href=#__codelineno-24-28>28</a></span>
<span class=normal><a href=#__codelineno-24-29>29</a></span>
<span class=normal><a href=#__codelineno-24-30>30</a></span>
<span class=normal><a href=#__codelineno-24-31>31</a></span>
<span class=normal><a href=#__codelineno-24-32>32</a></span>
<span class=normal><a href=#__codelineno-24-33>33</a></span>
<span class=normal><a href=#__codelineno-24-34>34</a></span>
<span class=normal><a href=#__codelineno-24-35>35</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_apigatewayv2_api&quot;</span><span class=w> </span><span class=nv>&quot;main&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2></a><span class=w>  </span><span class=na>name</span><span class=w>          </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;main&quot;</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3></a><span class=w>  </span><span class=na>protocol_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;HTTP&quot;</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4></a><span class=p>}</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5></a>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_apigatewayv2_stage&quot;</span><span class=w> </span><span class=nv>&quot;dev&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7></a><span class=w>  </span><span class=na>api_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_apigatewayv2_api.main.id</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8></a>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9></a><span class=w>  </span><span class=na>name</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;dev&quot;</span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10></a><span class=w>  </span><span class=na>auto_deploy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11></a>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12></a><span class=w>  </span><span class=nb>access_log_settings</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13></a><span class=w>    </span><span class=na>destination_arn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_cloudwatch_log_group.main_api_gw.arn</span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14></a>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15></a><span class=w>    </span><span class=na>format</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>jsonencode</span><span class=p>({</span>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16></a><span class=w>      </span><span class=na>requestId</span><span class=w>               </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;$context.requestId&quot;</span>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17></a><span class=w>      </span><span class=na>sourceIp</span><span class=w>                </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;$context.identity.sourceIp&quot;</span>
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18></a><span class=w>      </span><span class=na>requestTime</span><span class=w>             </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;$context.requestTime&quot;</span>
</span><span id=__span-24-19><a id=__codelineno-24-19 name=__codelineno-24-19></a><span class=w>      </span><span class=na>protocol</span><span class=w>                </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;$context.protocol&quot;</span>
</span><span id=__span-24-20><a id=__codelineno-24-20 name=__codelineno-24-20></a><span class=w>      </span><span class=na>httpMethod</span><span class=w>              </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;$context.httpMethod&quot;</span>
</span><span id=__span-24-21><a id=__codelineno-24-21 name=__codelineno-24-21></a><span class=w>      </span><span class=na>resourcePath</span><span class=w>            </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;$context.resourcePath&quot;</span>
</span><span id=__span-24-22><a id=__codelineno-24-22 name=__codelineno-24-22></a><span class=w>      </span><span class=na>routeKey</span><span class=w>                </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;$context.routeKey&quot;</span>
</span><span id=__span-24-23><a id=__codelineno-24-23 name=__codelineno-24-23></a><span class=w>      </span><span class=na>status</span><span class=w>                  </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;$context.status&quot;</span>
</span><span id=__span-24-24><a id=__codelineno-24-24 name=__codelineno-24-24></a><span class=w>      </span><span class=na>responseLength</span><span class=w>          </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;$context.responseLength&quot;</span>
</span><span id=__span-24-25><a id=__codelineno-24-25 name=__codelineno-24-25></a><span class=w>      </span><span class=na>integrationErrorMessage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;$context.integrationErrorMessage&quot;</span>
</span><span id=__span-24-26><a id=__codelineno-24-26 name=__codelineno-24-26></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-24-27><a id=__codelineno-24-27 name=__codelineno-24-27></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-24-28><a id=__codelineno-24-28 name=__codelineno-24-28></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-24-29><a id=__codelineno-24-29 name=__codelineno-24-29></a><span class=p>}</span>
</span><span id=__span-24-30><a id=__codelineno-24-30 name=__codelineno-24-30></a>
</span><span id=__span-24-31><a id=__codelineno-24-31 name=__codelineno-24-31></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_cloudwatch_log_group&quot;</span><span class=w> </span><span class=nv>&quot;main_api_gw&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-32><a id=__codelineno-24-32 name=__codelineno-24-32></a><span class=w>  </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;/aws/api-gw/${aws_apigatewayv2_api.main.name}&quot;</span>
</span><span id=__span-24-33><a id=__codelineno-24-33 name=__codelineno-24-33></a>
</span><span id=__span-24-34><a id=__codelineno-24-34 name=__codelineno-24-34></a><span class=w>  </span><span class=na>retention_in_days</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>30</span>
</span><span id=__span-24-35><a id=__codelineno-24-35 name=__codelineno-24-35></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h2 id=integrando-o-api-gateway-com-o-lambda>Integrando o API Gateway com o Lambda<a class=headerlink href=#integrando-o-api-gateway-com-o-lambda title="Permanent link">&para;</a></h2> <p>No próximo arquivo Terraform, integraremos o API Gateway com o hello lambda. Primeiramente apontaremos para o ID do API Gateway que acabamos de criar. Em seguida utilizaremos PROXYS AWS e solicitações POST para encaminhar solicitações do API Gateway para o Lambda</p> <div class="tabbed-set tabbed-alternate" data-tabs=13:1><input checked=checked id=__tabbed_13_1 name=__tabbed_13 type=radio><div class=tabbed-labels><label for=__tabbed_13_1><strong>terraform/hello-api-gateway.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-25-1>1</a></span>
<span class=normal><a href=#__codelineno-25-2>2</a></span>
<span class=normal><a href=#__codelineno-25-3>3</a></span>
<span class=normal><a href=#__codelineno-25-4>4</a></span>
<span class=normal><a href=#__codelineno-25-5>5</a></span>
<span class=normal><a href=#__codelineno-25-6>6</a></span>
<span class=normal><a href=#__codelineno-25-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_apigatewayv2_integration&quot;</span><span class=w> </span><span class=nv>&quot;lambda_hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2></a><span class=na>api_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_apigatewayv2_api.main.id</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3></a>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4></a><span class=na>integration_uri</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_lambda_function.hello.invoke_arn</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5></a><span class=na>integration_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;AWS_PROXY&quot;</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6></a><span class=na>integration_method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;POST&quot;</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Podemos especificar qual tipo de solicitações queremos passar para o lambda, por exemplo: GET ou POST, como abaixo:</p> <div class="tabbed-set tabbed-alternate" data-tabs=14:1><input checked=checked id=__tabbed_14_1 name=__tabbed_14 type=radio><div class=tabbed-labels><label for=__tabbed_14_1><strong>terraform/hello-api-gateway.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-26-1> 1</a></span>
<span class=normal><a href=#__codelineno-26-2> 2</a></span>
<span class=normal><a href=#__codelineno-26-3> 3</a></span>
<span class=normal><a href=#__codelineno-26-4> 4</a></span>
<span class=normal><a href=#__codelineno-26-5> 5</a></span>
<span class=normal><a href=#__codelineno-26-6> 6</a></span>
<span class=normal><a href=#__codelineno-26-7> 7</a></span>
<span class=normal><a href=#__codelineno-26-8> 8</a></span>
<span class=normal><a href=#__codelineno-26-9> 9</a></span>
<span class=normal><a href=#__codelineno-26-10>10</a></span>
<span class=normal><a href=#__codelineno-26-11>11</a></span>
<span class=normal><a href=#__codelineno-26-12>12</a></span>
<span class=normal><a href=#__codelineno-26-13>13</a></span>
<span class=normal><a href=#__codelineno-26-14>14</a></span>
<span class=normal><a href=#__codelineno-26-15>15</a></span>
<span class=normal><a href=#__codelineno-26-16>16</a></span>
<span class=normal><a href=#__codelineno-26-17>17</a></span>
<span class=normal><a href=#__codelineno-26-18>18</a></span>
<span class=normal><a href=#__codelineno-26-19>19</a></span>
<span class=normal><a href=#__codelineno-26-20>20</a></span>
<span class=normal><a href=#__codelineno-26-21>21</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_apigatewayv2_integration&quot;</span><span class=w> </span><span class=nv>&quot;lambda_hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2></a><span class=na>api_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_apigatewayv2_api.main.id</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3></a>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4></a><span class=na>integration_uri</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_lambda_function.hello.invoke_arn</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5></a><span class=na>integration_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;AWS_PROXY&quot;</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6></a><span class=na>integration_method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;POST&quot;</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7></a><span class=p>}</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8></a>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9></a><span class=err>+</span><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_apigatewayv2_route&quot;</span><span class=w> </span><span class=nv>&quot;get_hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10></a><span class=err>+</span><span class=na>api_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_apigatewayv2_api.main.id</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11></a>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12></a><span class=err>+</span><span class=na>route_key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;GET /hello&quot;</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13></a><span class=err>+</span><span class=na>target</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;integrations/${aws_apigatewayv2_integration.lambda_hello.id}&quot;</span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14></a><span class=err>+</span><span class=p>}</span>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15></a>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16></a><span class=err>+</span><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_apigatewayv2_route&quot;</span><span class=w> </span><span class=nv>&quot;post_hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17></a><span class=err>+</span><span class=na>api_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_apigatewayv2_api.main.id</span>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18></a>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19></a><span class=err>+</span><span class=na>route_key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;POST /hello&quot;</span>
</span><span id=__span-26-20><a id=__codelineno-26-20 name=__codelineno-26-20></a><span class=err>+</span><span class=na>target</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;integrations/${aws_apigatewayv2_integration.lambda_hello.id}&quot;</span>
</span><span id=__span-26-21><a id=__codelineno-26-21 name=__codelineno-26-21></a><span class=err>+</span><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Note que em ambos os exemplos é necessário especificar um destino para ser o nosso lambda. Também precisamos conceder permissões ao API Gateway para invocar nossa função lambda:</p> <div class="tabbed-set tabbed-alternate" data-tabs=15:1><input checked=checked id=__tabbed_15_1 name=__tabbed_15 type=radio><div class=tabbed-labels><label for=__tabbed_15_1><strong>terraform/hello-api-gateway.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-27-1> 1</a></span>
<span class=normal><a href=#__codelineno-27-2> 2</a></span>
<span class=normal><a href=#__codelineno-27-3> 3</a></span>
<span class=normal><a href=#__codelineno-27-4> 4</a></span>
<span class=normal><a href=#__codelineno-27-5> 5</a></span>
<span class=normal><a href=#__codelineno-27-6> 6</a></span>
<span class=normal><a href=#__codelineno-27-7> 7</a></span>
<span class=normal><a href=#__codelineno-27-8> 8</a></span>
<span class=normal><a href=#__codelineno-27-9> 9</a></span>
<span class=normal><a href=#__codelineno-27-10>10</a></span>
<span class=normal><a href=#__codelineno-27-11>11</a></span>
<span class=normal><a href=#__codelineno-27-12>12</a></span>
<span class=normal><a href=#__codelineno-27-13>13</a></span>
<span class=normal><a href=#__codelineno-27-14>14</a></span>
<span class=normal><a href=#__codelineno-27-15>15</a></span>
<span class=normal><a href=#__codelineno-27-16>16</a></span>
<span class=normal><a href=#__codelineno-27-17>17</a></span>
<span class=normal><a href=#__codelineno-27-18>18</a></span>
<span class=normal><a href=#__codelineno-27-19>19</a></span>
<span class=normal><a href=#__codelineno-27-20>20</a></span>
<span class=normal><a href=#__codelineno-27-21>21</a></span>
<span class=normal><a href=#__codelineno-27-22>22</a></span>
<span class=normal><a href=#__codelineno-27-23>23</a></span>
<span class=normal><a href=#__codelineno-27-24>24</a></span>
<span class=normal><a href=#__codelineno-27-25>25</a></span>
<span class=normal><a href=#__codelineno-27-26>26</a></span>
<span class=normal><a href=#__codelineno-27-27>27</a></span>
<span class=normal><a href=#__codelineno-27-28>28</a></span>
<span class=normal><a href=#__codelineno-27-29>29</a></span>
<span class=normal><a href=#__codelineno-27-30>30</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_apigatewayv2_integration&quot;</span><span class=w> </span><span class=nv>&quot;lambda_hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2></a><span class=w>  </span><span class=na>api_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_apigatewayv2_api.main.id</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3></a>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4></a><span class=w>  </span><span class=na>integration_uri</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=nv>aws_lambda_function.hello.invoke_arn</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5></a><span class=w>  </span><span class=na>integration_type</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;AWS_PROXY&quot;</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6></a><span class=w>  </span><span class=na>integration_method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;POST&quot;</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7></a><span class=p>}</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8></a>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_apigatewayv2_route&quot;</span><span class=w> </span><span class=nv>&quot;get_hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10></a><span class=w>  </span><span class=na>api_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_apigatewayv2_api.main.id</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11></a>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12></a><span class=w>  </span><span class=na>route_key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;GET /hello&quot;</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13></a><span class=w>  </span><span class=na>target</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;integrations/${aws_apigatewayv2_integration.lambda_hello.id}&quot;</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14></a><span class=p>}</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15></a>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_apigatewayv2_route&quot;</span><span class=w> </span><span class=nv>&quot;post_hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17></a><span class=w>  </span><span class=na>api_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_apigatewayv2_api.main.id</span>
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18></a>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19></a><span class=w>  </span><span class=na>route_key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;POST /hello&quot;</span>
</span><span id=__span-27-20><a id=__codelineno-27-20 name=__codelineno-27-20></a><span class=w>  </span><span class=na>target</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;integrations/${aws_apigatewayv2_integration.lambda_hello.id}&quot;</span>
</span><span id=__span-27-21><a id=__codelineno-27-21 name=__codelineno-27-21></a><span class=p>}</span>
</span><span id=__span-27-22><a id=__codelineno-27-22 name=__codelineno-27-22></a>
</span><span id=__span-27-23><a id=__codelineno-27-23 name=__codelineno-27-23></a><span class=err>+</span><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_lambda_permission&quot;</span><span class=w> </span><span class=nv>&quot;api_gw&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-24><a id=__codelineno-27-24 name=__codelineno-27-24></a><span class=err>+</span><span class=w>  </span><span class=na>statement_id</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;AllowExecutionFromAPIGateway&quot;</span>
</span><span id=__span-27-25><a id=__codelineno-27-25 name=__codelineno-27-25></a><span class=err>+</span><span class=w>  </span><span class=na>action</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;lambda:InvokeFunction&quot;</span>
</span><span id=__span-27-26><a id=__codelineno-27-26 name=__codelineno-27-26></a><span class=err>+</span><span class=w>  </span><span class=na>function_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_lambda_function.hello.function_name</span>
</span><span id=__span-27-27><a id=__codelineno-27-27 name=__codelineno-27-27></a><span class=err>+</span><span class=w>  </span><span class=na>principal</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;apigateway.amazonaws.com&quot;</span>
</span><span id=__span-27-28><a id=__codelineno-27-28 name=__codelineno-27-28></a>
</span><span id=__span-27-29><a id=__codelineno-27-29 name=__codelineno-27-29></a><span class=err>+</span><span class=w>  </span><span class=na>source_arn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;${aws_apigatewayv2_api.main.execution_arn}/*/*&quot;</span>
</span><span id=__span-27-30><a id=__codelineno-27-30 name=__codelineno-27-30></a><span class=err>+</span><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h2 id=invocando-o-lambda>Invocando o Lambda<a class=headerlink href=#invocando-o-lambda title="Permanent link">&para;</a></h2> <p>Por fim, vamos imprimir no console o URL que podemos usar para invocar o lambda.</p> <div class="tabbed-set tabbed-alternate" data-tabs=16:1><input checked=checked id=__tabbed_16_1 name=__tabbed_16 type=radio><div class=tabbed-labels><label for=__tabbed_16_1><strong>terraform/hello-api-gateway.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-28-1> 1</a></span>
<span class=normal><a href=#__codelineno-28-2> 2</a></span>
<span class=normal><a href=#__codelineno-28-3> 3</a></span>
<span class=normal><a href=#__codelineno-28-4> 4</a></span>
<span class=normal><a href=#__codelineno-28-5> 5</a></span>
<span class=normal><a href=#__codelineno-28-6> 6</a></span>
<span class=normal><a href=#__codelineno-28-7> 7</a></span>
<span class=normal><a href=#__codelineno-28-8> 8</a></span>
<span class=normal><a href=#__codelineno-28-9> 9</a></span>
<span class=normal><a href=#__codelineno-28-10>10</a></span>
<span class=normal><a href=#__codelineno-28-11>11</a></span>
<span class=normal><a href=#__codelineno-28-12>12</a></span>
<span class=normal><a href=#__codelineno-28-13>13</a></span>
<span class=normal><a href=#__codelineno-28-14>14</a></span>
<span class=normal><a href=#__codelineno-28-15>15</a></span>
<span class=normal><a href=#__codelineno-28-16>16</a></span>
<span class=normal><a href=#__codelineno-28-17>17</a></span>
<span class=normal><a href=#__codelineno-28-18>18</a></span>
<span class=normal><a href=#__codelineno-28-19>19</a></span>
<span class=normal><a href=#__codelineno-28-20>20</a></span>
<span class=normal><a href=#__codelineno-28-21>21</a></span>
<span class=normal><a href=#__codelineno-28-22>22</a></span>
<span class=normal><a href=#__codelineno-28-23>23</a></span>
<span class=normal><a href=#__codelineno-28-24>24</a></span>
<span class=normal><a href=#__codelineno-28-25>25</a></span>
<span class=normal><a href=#__codelineno-28-26>26</a></span>
<span class=normal><a href=#__codelineno-28-27>27</a></span>
<span class=normal><a href=#__codelineno-28-28>28</a></span>
<span class=normal><a href=#__codelineno-28-29>29</a></span>
<span class=normal><a href=#__codelineno-28-30>30</a></span>
<span class=normal><a href=#__codelineno-28-31>31</a></span>
<span class=normal><a href=#__codelineno-28-32>32</a></span>
<span class=normal><a href=#__codelineno-28-33>33</a></span>
<span class=normal><a href=#__codelineno-28-34>34</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_apigatewayv2_integration&quot;</span><span class=w> </span><span class=nv>&quot;lambda_hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2></a><span class=w>  </span><span class=na>api_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_apigatewayv2_api.main.id</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3></a>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4></a><span class=w>  </span><span class=na>integration_uri</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=nv>aws_lambda_function.hello.invoke_arn</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5></a><span class=w>  </span><span class=na>integration_type</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;AWS_PROXY&quot;</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6></a><span class=w>  </span><span class=na>integration_method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;POST&quot;</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7></a><span class=p>}</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8></a>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_apigatewayv2_route&quot;</span><span class=w> </span><span class=nv>&quot;get_hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10></a><span class=w>  </span><span class=na>api_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_apigatewayv2_api.main.id</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11></a>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12></a><span class=w>  </span><span class=na>route_key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;GET /hello&quot;</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13></a><span class=w>  </span><span class=na>target</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;integrations/${aws_apigatewayv2_integration.lambda_hello.id}&quot;</span>
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14></a><span class=p>}</span>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15></a>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_apigatewayv2_route&quot;</span><span class=w> </span><span class=nv>&quot;post_hello&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17></a><span class=w>  </span><span class=na>api_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_apigatewayv2_api.main.id</span>
</span><span id=__span-28-18><a id=__codelineno-28-18 name=__codelineno-28-18></a>
</span><span id=__span-28-19><a id=__codelineno-28-19 name=__codelineno-28-19></a><span class=w>  </span><span class=na>route_key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;POST /hello&quot;</span>
</span><span id=__span-28-20><a id=__codelineno-28-20 name=__codelineno-28-20></a><span class=w>  </span><span class=na>target</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;integrations/${aws_apigatewayv2_integration.lambda_hello.id}&quot;</span>
</span><span id=__span-28-21><a id=__codelineno-28-21 name=__codelineno-28-21></a><span class=p>}</span>
</span><span id=__span-28-22><a id=__codelineno-28-22 name=__codelineno-28-22></a>
</span><span id=__span-28-23><a id=__codelineno-28-23 name=__codelineno-28-23></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_lambda_permission&quot;</span><span class=w> </span><span class=nv>&quot;api_gw&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-24><a id=__codelineno-28-24 name=__codelineno-28-24></a><span class=w>  </span><span class=na>statement_id</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;AllowExecutionFromAPIGateway&quot;</span>
</span><span id=__span-28-25><a id=__codelineno-28-25 name=__codelineno-28-25></a><span class=w>  </span><span class=na>action</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;lambda:InvokeFunction&quot;</span>
</span><span id=__span-28-26><a id=__codelineno-28-26 name=__codelineno-28-26></a><span class=w>  </span><span class=na>function_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_lambda_function.hello.function_name</span>
</span><span id=__span-28-27><a id=__codelineno-28-27 name=__codelineno-28-27></a><span class=w>  </span><span class=na>principal</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;apigateway.amazonaws.com&quot;</span>
</span><span id=__span-28-28><a id=__codelineno-28-28 name=__codelineno-28-28></a>
</span><span id=__span-28-29><a id=__codelineno-28-29 name=__codelineno-28-29></a><span class=w>  </span><span class=na>source_arn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;${aws_apigatewayv2_api.main.execution_arn}/*/*&quot;</span>
</span><span id=__span-28-30><a id=__codelineno-28-30 name=__codelineno-28-30></a><span class=p>}</span>
</span><span id=__span-28-31><a id=__codelineno-28-31 name=__codelineno-28-31></a>
</span><span id=__span-28-32><a id=__codelineno-28-32 name=__codelineno-28-32></a><span class=err>+</span><span class=kr>output</span><span class=w> </span><span class=nv>&quot;hello_base_url&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-33><a id=__codelineno-28-33 name=__codelineno-28-33></a><span class=err>+</span><span class=w>  </span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_apigatewayv2_stage.dev.invoke_url</span>
</span><span id=__span-28-34><a id=__codelineno-28-34 name=__codelineno-28-34></a><span class=err>+</span><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>No terminal, daremos um apply no terraform.</p> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-29-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1></a><span class=err>terraform</span><span class=w> </span><span class=err>apply</span>
</span></code></pre></div></td></tr></table></div> <p><img alt=terraforminit src=screenshots/0010.png></p> <blockquote> <p><img alt=⚠ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/26a0.svg title=:warning:> <strong>Dica visual</strong></p> <p><em>Se entrarmos no dashboard do <strong>API Gateway</strong>, podemos ver nosso estágio de desenvolvimento "dev" criado e, em "rotas", conseguimos encontrar os métodos <strong><em>GET e POST.</em></strong></em> &gt; <img alt=terraforminit src=screenshots/0011.png> &gt; <img alt=terraforminit src=screenshots/0012.png></p> </blockquote> <p>Até essa etapa, <strong>se você estiver seguindo a risca minha forma de fazer esse handout</strong>, é esperada que a estrutura do seu código esteja como na imagem abaixo:</p> <p><img alt=terraforminit src=screenshots/009.png></p> <h2 id=hora-de-testar>Hora de testar<a class=headerlink href=#hora-de-testar title="Permanent link">&para;</a></h2> <p>Vamos agora testar o método HTTP GET. A função deve analisá-lo e retornar a mensagem <strong>"Olá, <em>+ parâmetro de URL</em>"</strong></p> <div class="language-tf highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=err>curl</span><span class=w> </span><span class=s2>&quot;https://&lt;id&gt;.execute-api.us-east-1.amazonaws.com/dev/hello?Name=InsperUniversity&quot;</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=w>               </span><span class=err>/</span>\
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=w>               </span><span class=err>||</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=err>Substitua</span><span class=w> </span><span class=err>&lt;id&gt;</span><span class=w> </span><span class=err>pelo</span><span class=w> </span><span class=err>seu</span><span class=w> </span><span class=err>id</span><span class=w> </span><span class=err>retornado</span><span class=w> </span><span class=err>no</span><span class=w> </span><span class=err>prompt</span><span class=w> </span><span class=err>de</span><span class=w> </span><span class=err>comando</span>
</span></code></pre></div> <p><img alt=GET src=screenshots/0013.png></p> <p>Também testaremos o método POST. Nesse caso, fornecemos um objeto json para o terminal e veremos que funciona também.</p> <div class="language-tf highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=err>curl</span><span class=w> </span><span class=err>-X</span><span class=w> </span><span class=err>POST</span><span class=w> </span>\
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=err>-H</span><span class=w> </span><span class=s2>&quot;Content-Type: application/json&quot;</span><span class=w> </span>\
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=err>-d</span><span class=w> </span><span class=err>&#39;</span><span class=p>{</span><span class=s2>&quot;name&quot;</span><span class=o>:</span><span class=s2>&quot;Insper&quot;</span><span class=p>}</span><span class=err>&#39;</span><span class=w> </span>\
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=s2>&quot;https://&lt;id&gt;.execute-api.us-east-1.amazonaws.com/dev/hello&quot;</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=w>          </span><span class=err>/</span>\
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=w>          </span><span class=err>||</span>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=err>Substitua</span><span class=w> </span><span class=err>&lt;id&gt;</span><span class=w> </span><span class=err>pelo</span><span class=w> </span><span class=err>seu</span><span class=w> </span><span class=err>id</span><span class=w> </span><span class=err>retornado</span><span class=w> </span><span class=err>no</span><span class=w> </span><span class=err>prompt</span><span class=w> </span><span class=err>de</span><span class=w> </span><span class=err>comando</span>
</span></code></pre></div> <p><img alt=POST src=screenshots/0014.png></p> <div class="admonition dica"> <p class=admonition-title>Dica</p> <p>Além do prompt de comando, teste também diretamente no seu navegador! Para fazer isso, basta substituir a url que foi retornada e passar algum parâmetro após "Name", da seguinte forma:</p> <p>https:// SEU-ID-AQUI .execute-api.us-east-1.amazonaws.com/dev/hello <strong>+ o parâmetro</strong> ?Name=Lister</p> <p>Por exemplo:</p> <p><a href="https://2cmcnumb2l.execute-api.us-east-1.amazonaws.com/dev/hello?Name=Lister">https://2cmcnumb2l.execute-api.us-east-1.amazonaws.com/dev/hello?Name=Lister</a></p> </div> <blockquote> <p><img alt=⚠ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/26a0.svg title=:warning:> <strong>Dica visual</strong></p> <p><em>Se entrarmos no dashboard do <strong>CloudWatch</strong>, conseguiremos ver os logs de acesso registrados para nossas solicitações.</em> &gt; <img alt=Logs_CloudWatch src=screenshots/0016.png> &gt; <img alt=Logs_CloudWatch src=screenshots/0027.png></p> </blockquote> <h2 id=criando-funcao-lambda-com-dependencias-externas-e-acesso-ao-bucket-s3>Criando função lambda com dependências externas e acesso ao bucket S3<a class=headerlink href=#criando-funcao-lambda-com-dependencias-externas-e-acesso-ao-bucket-s3 title="Permanent link">&para;</a></h2> <p>Vamos agora criar outra função lambda com dependências externas e que garanta acesso para a leitura de um arquivo em um bucket S3.</p> <p>Novamente, utilizaremos o random pet para nos auxiliar com um nome aleatório e único para nosso bucket do S3 e dicionaremos o prefixo "test" (o que também auxilia na identificação do bucket).</p> <p>Para esse bucket também deixaremos o acesso público desativado.</p> <div class="tabbed-set tabbed-alternate" data-tabs=17:1><input checked=checked id=__tabbed_17_1 name=__tabbed_17 type=radio><div class=tabbed-labels><label for=__tabbed_17_1><strong>terraform/test-bucket.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-32-1> 1</a></span>
<span class=normal><a href=#__codelineno-32-2> 2</a></span>
<span class=normal><a href=#__codelineno-32-3> 3</a></span>
<span class=normal><a href=#__codelineno-32-4> 4</a></span>
<span class=normal><a href=#__codelineno-32-5> 5</a></span>
<span class=normal><a href=#__codelineno-32-6> 6</a></span>
<span class=normal><a href=#__codelineno-32-7> 7</a></span>
<span class=normal><a href=#__codelineno-32-8> 8</a></span>
<span class=normal><a href=#__codelineno-32-9> 9</a></span>
<span class=normal><a href=#__codelineno-32-10>10</a></span>
<span class=normal><a href=#__codelineno-32-11>11</a></span>
<span class=normal><a href=#__codelineno-32-12>12</a></span>
<span class=normal><a href=#__codelineno-32-13>13</a></span>
<span class=normal><a href=#__codelineno-32-14>14</a></span>
<span class=normal><a href=#__codelineno-32-15>15</a></span>
<span class=normal><a href=#__codelineno-32-16>16</a></span>
<span class=normal><a href=#__codelineno-32-17>17</a></span>
<span class=normal><a href=#__codelineno-32-18>18</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;random_pet&quot;</span><span class=w> </span><span class=nv>&quot;test_bucket_name&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2></a><span class=w>  </span><span class=na>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;test&quot;</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3></a><span class=w>  </span><span class=na>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>2</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4></a><span class=p>}</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5></a>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_s3_bucket&quot;</span><span class=w> </span><span class=nv>&quot;test&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7></a><span class=w>  </span><span class=na>bucket</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=nv>random_pet.test_bucket_name.id</span>
</span><span id=__span-32-8><a id=__codelineno-32-8 name=__codelineno-32-8></a><span class=w>  </span><span class=na>force_destroy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-32-9><a id=__codelineno-32-9 name=__codelineno-32-9></a><span class=p>}</span>
</span><span id=__span-32-10><a id=__codelineno-32-10 name=__codelineno-32-10></a>
</span><span id=__span-32-11><a id=__codelineno-32-11 name=__codelineno-32-11></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_s3_bucket_public_access_block&quot;</span><span class=w> </span><span class=nv>&quot;test&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-12><a id=__codelineno-32-12 name=__codelineno-32-12></a><span class=w>  </span><span class=na>bucket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_bucket.test.id</span>
</span><span id=__span-32-13><a id=__codelineno-32-13 name=__codelineno-32-13></a>
</span><span id=__span-32-14><a id=__codelineno-32-14 name=__codelineno-32-14></a><span class=w>  </span><span class=na>block_public_acls</span><span class=w>       </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-32-15><a id=__codelineno-32-15 name=__codelineno-32-15></a><span class=w>  </span><span class=na>block_public_policy</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-32-16><a id=__codelineno-32-16 name=__codelineno-32-16></a><span class=w>  </span><span class=na>ignore_public_acls</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-32-17><a id=__codelineno-32-17 name=__codelineno-32-17></a><span class=w>  </span><span class=na>restrict_public_buckets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-32-18><a id=__codelineno-32-18 name=__codelineno-32-18></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Nós também podemos criar um objeto no S3 bucket utilizando terraform e o jsoncode build-in. Isso irá converter para um objeto json válido.</p> <div class="tabbed-set tabbed-alternate" data-tabs=18:1><input checked=checked id=__tabbed_18_1 name=__tabbed_18 type=radio><div class=tabbed-labels><label for=__tabbed_18_1><strong>terraform/test-bucket.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-33-1> 1</a></span>
<span class=normal><a href=#__codelineno-33-2> 2</a></span>
<span class=normal><a href=#__codelineno-33-3> 3</a></span>
<span class=normal><a href=#__codelineno-33-4> 4</a></span>
<span class=normal><a href=#__codelineno-33-5> 5</a></span>
<span class=normal><a href=#__codelineno-33-6> 6</a></span>
<span class=normal><a href=#__codelineno-33-7> 7</a></span>
<span class=normal><a href=#__codelineno-33-8> 8</a></span>
<span class=normal><a href=#__codelineno-33-9> 9</a></span>
<span class=normal><a href=#__codelineno-33-10>10</a></span>
<span class=normal><a href=#__codelineno-33-11>11</a></span>
<span class=normal><a href=#__codelineno-33-12>12</a></span>
<span class=normal><a href=#__codelineno-33-13>13</a></span>
<span class=normal><a href=#__codelineno-33-14>14</a></span>
<span class=normal><a href=#__codelineno-33-15>15</a></span>
<span class=normal><a href=#__codelineno-33-16>16</a></span>
<span class=normal><a href=#__codelineno-33-17>17</a></span>
<span class=normal><a href=#__codelineno-33-18>18</a></span>
<span class=normal><a href=#__codelineno-33-19>19</a></span>
<span class=normal><a href=#__codelineno-33-20>20</a></span>
<span class=normal><a href=#__codelineno-33-21>21</a></span>
<span class=normal><a href=#__codelineno-33-22>22</a></span>
<span class=normal><a href=#__codelineno-33-23>23</a></span>
<span class=normal><a href=#__codelineno-33-24>24</a></span>
<span class=normal><a href=#__codelineno-33-25>25</a></span>
<span class=normal><a href=#__codelineno-33-26>26</a></span>
<span class=normal><a href=#__codelineno-33-27>27</a></span>
<span class=normal><a href=#__codelineno-33-28>28</a></span>
<span class=normal><a href=#__codelineno-33-29>29</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;random_pet&quot;</span><span class=w> </span><span class=nv>&quot;test_bucket_name&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2></a><span class=w>  </span><span class=na>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;test&quot;</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3></a><span class=w>  </span><span class=na>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>2</span>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4></a><span class=p>}</span>
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5></a>
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_s3_bucket&quot;</span><span class=w> </span><span class=nv>&quot;test&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-7><a id=__codelineno-33-7 name=__codelineno-33-7></a><span class=w>  </span><span class=na>bucket</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=nv>random_pet.test_bucket_name.id</span>
</span><span id=__span-33-8><a id=__codelineno-33-8 name=__codelineno-33-8></a><span class=w>  </span><span class=na>force_destroy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-33-9><a id=__codelineno-33-9 name=__codelineno-33-9></a><span class=p>}</span>
</span><span id=__span-33-10><a id=__codelineno-33-10 name=__codelineno-33-10></a>
</span><span id=__span-33-11><a id=__codelineno-33-11 name=__codelineno-33-11></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_s3_bucket_public_access_block&quot;</span><span class=w> </span><span class=nv>&quot;test&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-12><a id=__codelineno-33-12 name=__codelineno-33-12></a><span class=w>  </span><span class=na>bucket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_bucket.test.id</span>
</span><span id=__span-33-13><a id=__codelineno-33-13 name=__codelineno-33-13></a>
</span><span id=__span-33-14><a id=__codelineno-33-14 name=__codelineno-33-14></a><span class=w>  </span><span class=na>block_public_acls</span><span class=w>       </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-33-15><a id=__codelineno-33-15 name=__codelineno-33-15></a><span class=w>  </span><span class=na>block_public_policy</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-33-16><a id=__codelineno-33-16 name=__codelineno-33-16></a><span class=w>  </span><span class=na>ignore_public_acls</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-33-17><a id=__codelineno-33-17 name=__codelineno-33-17></a><span class=w>  </span><span class=na>restrict_public_buckets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-33-18><a id=__codelineno-33-18 name=__codelineno-33-18></a><span class=p>}</span>
</span><span id=__span-33-19><a id=__codelineno-33-19 name=__codelineno-33-19></a>
</span><span id=__span-33-20><a id=__codelineno-33-20 name=__codelineno-33-20></a><span class=err>+</span><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_s3_object&quot;</span><span class=w> </span><span class=nv>&quot;test&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-21><a id=__codelineno-33-21 name=__codelineno-33-21></a><span class=err>+</span><span class=w>  </span><span class=na>bucket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_bucket.test.id</span>
</span><span id=__span-33-22><a id=__codelineno-33-22 name=__codelineno-33-22></a>
</span><span id=__span-33-23><a id=__codelineno-33-23 name=__codelineno-33-23></a><span class=err>+</span><span class=w>  </span><span class=na>key</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;hello.json&quot;</span>
</span><span id=__span-33-24><a id=__codelineno-33-24 name=__codelineno-33-24></a><span class=err>+</span><span class=w>  </span><span class=na>content</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>jsonencode</span><span class=p>({</span><span class=w> </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;S3&quot;</span><span class=w> </span><span class=p>})</span>
</span><span id=__span-33-25><a id=__codelineno-33-25 name=__codelineno-33-25></a><span class=err>+</span><span class=p>}</span>
</span><span id=__span-33-26><a id=__codelineno-33-26 name=__codelineno-33-26></a>
</span><span id=__span-33-27><a id=__codelineno-33-27 name=__codelineno-33-27></a><span class=err>+</span><span class=kr>output</span><span class=w> </span><span class=nv>&quot;test_s3_bucket&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-28><a id=__codelineno-33-28 name=__codelineno-33-28></a><span class=err>+</span><span class=w>  </span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>random_pet.test_bucket_name.id</span>
</span><span id=__span-33-29><a id=__codelineno-33-29 name=__codelineno-33-29></a><span class=err>+</span><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Agora iremos criar uma nova função lambda em uma nova pasta s3.</p> <p>Começaremos importando o aws-sdk e inicializando o objeto javascript.</p> <p>Essa função irá nos retornar o conteúdo do objeto.</p> <div class="tabbed-set tabbed-alternate" data-tabs=19:1><input checked=checked id=__tabbed_19_1 name=__tabbed_19 type=radio><div class=tabbed-labels><label for=__tabbed_19_1><strong>s3/function.js</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-js highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-34-1> 1</a></span>
<span class=normal><a href=#__codelineno-34-2> 2</a></span>
<span class=normal><a href=#__codelineno-34-3> 3</a></span>
<span class=normal><a href=#__codelineno-34-4> 4</a></span>
<span class=normal><a href=#__codelineno-34-5> 5</a></span>
<span class=normal><a href=#__codelineno-34-6> 6</a></span>
<span class=normal><a href=#__codelineno-34-7> 7</a></span>
<span class=normal><a href=#__codelineno-34-8> 8</a></span>
<span class=normal><a href=#__codelineno-34-9> 9</a></span>
<span class=normal><a href=#__codelineno-34-10>10</a></span>
<span class=normal><a href=#__codelineno-34-11>11</a></span>
<span class=normal><a href=#__codelineno-34-12>12</a></span>
<span class=normal><a href=#__codelineno-34-13>13</a></span>
<span class=normal><a href=#__codelineno-34-14>14</a></span>
<span class=normal><a href=#__codelineno-34-15>15</a></span>
<span class=normal><a href=#__codelineno-34-16>16</a></span>
<span class=normal><a href=#__codelineno-34-17>17</a></span>
<span class=normal><a href=#__codelineno-34-18>18</a></span>
<span class=normal><a href=#__codelineno-34-19>19</a></span>
<span class=normal><a href=#__codelineno-34-20>20</a></span>
<span class=normal><a href=#__codelineno-34-21>21</a></span>
<span class=normal><a href=#__codelineno-34-22>22</a></span>
<span class=normal><a href=#__codelineno-34-23>23</a></span>
<span class=normal><a href=#__codelineno-34-24>24</a></span>
<span class=normal><a href=#__codelineno-34-25>25</a></span>
<span class=normal><a href=#__codelineno-34-26>26</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1></a><span class=kd>const</span><span class=w> </span><span class=nx>aws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s2>&quot;aws-sdk&quot;</span><span class=p>);</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2></a>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3></a><span class=kd>const</span><span class=w> </span><span class=nx>s3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>aws</span><span class=p>.</span><span class=nx>S3</span><span class=p>({</span><span class=w> </span><span class=nx>apiVersion</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;2006-03-01&quot;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4></a>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5></a><span class=nx>exports</span><span class=p>.</span><span class=nx>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>(</span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>context</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&quot;Received event:&quot;</span><span class=p>,</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=mf>2</span><span class=p>));</span>
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7></a>
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bucket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>bucket</span><span class=p>;</span>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>object</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>object</span><span class=p>;</span>
</span><span id=__span-34-10><a id=__codelineno-34-10 name=__codelineno-34-10></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>decodeURIComponent</span><span class=p>(</span><span class=nx>object</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/\+/g</span><span class=p>,</span><span class=w> </span><span class=s2>&quot; &quot;</span><span class=p>));</span>
</span><span id=__span-34-11><a id=__codelineno-34-11 name=__codelineno-34-11></a>
</span><span id=__span-34-12><a id=__codelineno-34-12 name=__codelineno-34-12></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-13><a id=__codelineno-34-13 name=__codelineno-34-13></a><span class=w>    </span><span class=nx>Bucket</span><span class=o>:</span><span class=w> </span><span class=nx>bucket</span><span class=p>,</span>
</span><span id=__span-34-14><a id=__codelineno-34-14 name=__codelineno-34-14></a><span class=w>    </span><span class=nx>Key</span><span class=o>:</span><span class=w> </span><span class=nx>key</span><span class=p>,</span>
</span><span id=__span-34-15><a id=__codelineno-34-15 name=__codelineno-34-15></a><span class=w>  </span><span class=p>};</span>
</span><span id=__span-34-16><a id=__codelineno-34-16 name=__codelineno-34-16></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-17><a id=__codelineno-34-17 name=__codelineno-34-17></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Body</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>s3</span><span class=p>.</span><span class=nx>getObject</span><span class=p>(</span><span class=nx>params</span><span class=p>).</span><span class=nx>promise</span><span class=p>();</span>
</span><span id=__span-34-18><a id=__codelineno-34-18 name=__codelineno-34-18></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>content</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Body</span><span class=p>.</span><span class=nx>toString</span><span class=p>(</span><span class=s2>&quot;utf-8&quot;</span><span class=p>);</span>
</span><span id=__span-34-19><a id=__codelineno-34-19 name=__codelineno-34-19></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>content</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s2>&quot; Yeah, I am working, Avelinux :) !!&quot;</span><span class=p>;</span>
</span><span id=__span-34-20><a id=__codelineno-34-20 name=__codelineno-34-20></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-21><a id=__codelineno-34-21 name=__codelineno-34-21></a><span class=w>    </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span><span id=__span-34-22><a id=__codelineno-34-22 name=__codelineno-34-22></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sb>`Error getting object </span><span class=si>${</span><span class=nx>key</span><span class=si>}</span><span class=sb> from bucket </span><span class=si>${</span><span class=nx>bucket</span><span class=si>}</span><span class=sb>.`</span><span class=p>;</span>
</span><span id=__span-34-23><a id=__codelineno-34-23 name=__codelineno-34-23></a><span class=w>    </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>message</span><span class=p>);</span>
</span><span id=__span-34-24><a id=__codelineno-34-24 name=__codelineno-34-24></a><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=nx>message</span><span class=p>);</span>
</span><span id=__span-34-25><a id=__codelineno-34-25 name=__codelineno-34-25></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-34-26><a id=__codelineno-34-26 name=__codelineno-34-26></a><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>Dentro do diretório da recém-criada pasta "s3", devemos inicializar o projeto nodejs com o seguinte comando:</p> <div class="tabbed-set tabbed-alternate" data-tabs=20:1><input checked=checked id=__tabbed_20_1 name=__tabbed_20 type=radio><div class=tabbed-labels><label for=__tabbed_20_1><strong>/s3</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=err>npm</span><span class=w> </span><span class=err>init</span>
</span></code></pre></div> <p>Esse comando irá gerar arquivos <em>package.json</em> com dependências. <strong><em>Não há necessidade de preencher as informações solicitadas, basta teclar "enter" para cada info solicitada.</em></strong></p> <p><img alt=Logs_CloudWatch src=screenshots/0018.png></p> <p>Em seguida, iremos instalar o módulo <a href=https://aws.amazon.com/pt/sdk-for-javascript/ >aws-sdk</a>:</p> <div class="tabbed-set tabbed-alternate" data-tabs=21:1><input checked=checked id=__tabbed_21_1 name=__tabbed_21 type=radio><div class=tabbed-labels><label for=__tabbed_21_1><strong>/s3</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=err>npm</span><span class=w> </span><span class=err>install</span><span class=w> </span><span class=err>aws-sdk</span>
</span></code></pre></div> <p><img alt=Logs_CloudWatch src=screenshots/0019.png></p> <p>Agora retornaremos à pasta "Terraform" e iremos criar nossas políticas de acesso.</p> <div class="tabbed-set tabbed-alternate" data-tabs=22:1><input checked=checked id=__tabbed_22_1 name=__tabbed_22 type=radio><div class=tabbed-labels><label for=__tabbed_22_1><strong>terraform/s3-lambda.tf</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-tf highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-37-1> 1</a></span>
<span class=normal><a href=#__codelineno-37-2> 2</a></span>
<span class=normal><a href=#__codelineno-37-3> 3</a></span>
<span class=normal><a href=#__codelineno-37-4> 4</a></span>
<span class=normal><a href=#__codelineno-37-5> 5</a></span>
<span class=normal><a href=#__codelineno-37-6> 6</a></span>
<span class=normal><a href=#__codelineno-37-7> 7</a></span>
<span class=normal><a href=#__codelineno-37-8> 8</a></span>
<span class=normal><a href=#__codelineno-37-9> 9</a></span>
<span class=normal><a href=#__codelineno-37-10>10</a></span>
<span class=normal><a href=#__codelineno-37-11>11</a></span>
<span class=normal><a href=#__codelineno-37-12>12</a></span>
<span class=normal><a href=#__codelineno-37-13>13</a></span>
<span class=normal><a href=#__codelineno-37-14>14</a></span>
<span class=normal><a href=#__codelineno-37-15>15</a></span>
<span class=normal><a href=#__codelineno-37-16>16</a></span>
<span class=normal><a href=#__codelineno-37-17>17</a></span>
<span class=normal><a href=#__codelineno-37-18>18</a></span>
<span class=normal><a href=#__codelineno-37-19>19</a></span>
<span class=normal><a href=#__codelineno-37-20>20</a></span>
<span class=normal><a href=#__codelineno-37-21>21</a></span>
<span class=normal><a href=#__codelineno-37-22>22</a></span>
<span class=normal><a href=#__codelineno-37-23>23</a></span>
<span class=normal><a href=#__codelineno-37-24>24</a></span>
<span class=normal><a href=#__codelineno-37-25>25</a></span>
<span class=normal><a href=#__codelineno-37-26>26</a></span>
<span class=normal><a href=#__codelineno-37-27>27</a></span>
<span class=normal><a href=#__codelineno-37-28>28</a></span>
<span class=normal><a href=#__codelineno-37-29>29</a></span>
<span class=normal><a href=#__codelineno-37-30>30</a></span>
<span class=normal><a href=#__codelineno-37-31>31</a></span>
<span class=normal><a href=#__codelineno-37-32>32</a></span>
<span class=normal><a href=#__codelineno-37-33>33</a></span>
<span class=normal><a href=#__codelineno-37-34>34</a></span>
<span class=normal><a href=#__codelineno-37-35>35</a></span>
<span class=normal><a href=#__codelineno-37-36>36</a></span>
<span class=normal><a href=#__codelineno-37-37>37</a></span>
<span class=normal><a href=#__codelineno-37-38>38</a></span>
<span class=normal><a href=#__codelineno-37-39>39</a></span>
<span class=normal><a href=#__codelineno-37-40>40</a></span>
<span class=normal><a href=#__codelineno-37-41>41</a></span>
<span class=normal><a href=#__codelineno-37-42>42</a></span>
<span class=normal><a href=#__codelineno-37-43>43</a></span>
<span class=normal><a href=#__codelineno-37-44>44</a></span>
<span class=normal><a href=#__codelineno-37-45>45</a></span>
<span class=normal><a href=#__codelineno-37-46>46</a></span>
<span class=normal><a href=#__codelineno-37-47>47</a></span>
<span class=normal><a href=#__codelineno-37-48>48</a></span>
<span class=normal><a href=#__codelineno-37-49>49</a></span>
<span class=normal><a href=#__codelineno-37-50>50</a></span>
<span class=normal><a href=#__codelineno-37-51>51</a></span>
<span class=normal><a href=#__codelineno-37-52>52</a></span>
<span class=normal><a href=#__codelineno-37-53>53</a></span>
<span class=normal><a href=#__codelineno-37-54>54</a></span>
<span class=normal><a href=#__codelineno-37-55>55</a></span>
<span class=normal><a href=#__codelineno-37-56>56</a></span>
<span class=normal><a href=#__codelineno-37-57>57</a></span>
<span class=normal><a href=#__codelineno-37-58>58</a></span>
<span class=normal><a href=#__codelineno-37-59>59</a></span>
<span class=normal><a href=#__codelineno-37-60>60</a></span>
<span class=normal><a href=#__codelineno-37-61>61</a></span>
<span class=normal><a href=#__codelineno-37-62>62</a></span>
<span class=normal><a href=#__codelineno-37-63>63</a></span>
<span class=normal><a href=#__codelineno-37-64>64</a></span>
<span class=normal><a href=#__codelineno-37-65>65</a></span>
<span class=normal><a href=#__codelineno-37-66>66</a></span>
<span class=normal><a href=#__codelineno-37-67>67</a></span>
<span class=normal><a href=#__codelineno-37-68>68</a></span>
<span class=normal><a href=#__codelineno-37-69>69</a></span>
<span class=normal><a href=#__codelineno-37-70>70</a></span>
<span class=normal><a href=#__codelineno-37-71>71</a></span>
<span class=normal><a href=#__codelineno-37-72>72</a></span>
<span class=normal><a href=#__codelineno-37-73>73</a></span>
<span class=normal><a href=#__codelineno-37-74>74</a></span>
<span class=normal><a href=#__codelineno-37-75>75</a></span>
<span class=normal><a href=#__codelineno-37-76>76</a></span>
<span class=normal><a href=#__codelineno-37-77>77</a></span>
<span class=normal><a href=#__codelineno-37-78>78</a></span>
<span class=normal><a href=#__codelineno-37-79>79</a></span>
<span class=normal><a href=#__codelineno-37-80>80</a></span>
<span class=normal><a href=#__codelineno-37-81>81</a></span>
<span class=normal><a href=#__codelineno-37-82>82</a></span>
<span class=normal><a href=#__codelineno-37-83>83</a></span>
<span class=normal><a href=#__codelineno-37-84>84</a></span>
<span class=normal><a href=#__codelineno-37-85>85</a></span>
<span class=normal><a href=#__codelineno-37-86>86</a></span>
<span class=normal><a href=#__codelineno-37-87>87</a></span>
<span class=normal><a href=#__codelineno-37-88>88</a></span>
<span class=normal><a href=#__codelineno-37-89>89</a></span>
<span class=normal><a href=#__codelineno-37-90>90</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_iam_role&quot;</span><span class=w> </span><span class=nv>&quot;s3_lambda_exec&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2></a><span class=w>  </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;s3-lambda&quot;</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3></a>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4></a><span class=w>  </span><span class=na>assume_role_policy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=dl>POLICY</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5></a><span class=sh>{</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6></a><span class=sh>  &quot;Version&quot;: &quot;2012-10-17&quot;,</span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7></a><span class=sh>  &quot;Statement&quot;: [</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8></a><span class=sh>    {</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9></a><span class=sh>      &quot;Effect&quot;: &quot;Allow&quot;,</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10></a><span class=sh>      &quot;Principal&quot;: {</span>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11></a><span class=sh>        &quot;Service&quot;: &quot;lambda.amazonaws.com&quot;</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12></a><span class=sh>      },</span>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13></a><span class=sh>      &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14></a><span class=sh>    }</span>
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15></a><span class=sh>  ]</span>
</span><span id=__span-37-16><a id=__codelineno-37-16 name=__codelineno-37-16></a><span class=sh>}</span>
</span><span id=__span-37-17><a id=__codelineno-37-17 name=__codelineno-37-17></a><span class=dl>POLICY</span>
</span><span id=__span-37-18><a id=__codelineno-37-18 name=__codelineno-37-18></a><span class=p>}</span>
</span><span id=__span-37-19><a id=__codelineno-37-19 name=__codelineno-37-19></a>
</span><span id=__span-37-20><a id=__codelineno-37-20 name=__codelineno-37-20></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_iam_role_policy_attachment&quot;</span><span class=w> </span><span class=nv>&quot;s3_lambda_policy&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-21><a id=__codelineno-37-21 name=__codelineno-37-21></a><span class=w>  </span><span class=na>role</span><span class=w>       </span><span class=o>=</span><span class=w> </span><span class=nv>aws_iam_role.s3_lambda_exec.name</span>
</span><span id=__span-37-22><a id=__codelineno-37-22 name=__codelineno-37-22></a><span class=w>  </span><span class=na>policy_arn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;</span>
</span><span id=__span-37-23><a id=__codelineno-37-23 name=__codelineno-37-23></a><span class=p>}</span>
</span><span id=__span-37-24><a id=__codelineno-37-24 name=__codelineno-37-24></a>
</span><span id=__span-37-25><a id=__codelineno-37-25 name=__codelineno-37-25></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_iam_policy&quot;</span><span class=w> </span><span class=nv>&quot;test_s3_bucket_access&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-26><a id=__codelineno-37-26 name=__codelineno-37-26></a><span class=w>  </span><span class=na>name</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;TestS3BucketAccess&quot;</span>
</span><span id=__span-37-27><a id=__codelineno-37-27 name=__codelineno-37-27></a>
</span><span id=__span-37-28><a id=__codelineno-37-28 name=__codelineno-37-28></a><span class=w>  </span><span class=na>policy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>jsonencode</span><span class=p>({</span>
</span><span id=__span-37-29><a id=__codelineno-37-29 name=__codelineno-37-29></a><span class=w>    </span><span class=na>Version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;2012-10-17&quot;</span>
</span><span id=__span-37-30><a id=__codelineno-37-30 name=__codelineno-37-30></a><span class=w>    </span><span class=na>Statement</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-37-31><a id=__codelineno-37-31 name=__codelineno-37-31></a><span class=w>      </span><span class=p>{</span>
</span><span id=__span-37-32><a id=__codelineno-37-32 name=__codelineno-37-32></a><span class=w>        </span><span class=na>Action</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-37-33><a id=__codelineno-37-33 name=__codelineno-37-33></a><span class=w>          </span><span class=s2>&quot;s3:GetObject&quot;</span><span class=p>,</span><span class=c1> #Permitir obter um objeto do bucket</span>
</span><span id=__span-37-34><a id=__codelineno-37-34 name=__codelineno-37-34></a><span class=w>        </span><span class=p>]</span>
</span><span id=__span-37-35><a id=__codelineno-37-35 name=__codelineno-37-35></a><span class=w>        </span><span class=na>Effect</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;Allow&quot;</span>
</span><span id=__span-37-36><a id=__codelineno-37-36 name=__codelineno-37-36></a><span class=w>        </span><span class=na>Resource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;arn:aws:s3:::${aws_s3_bucket.test.id}/*&quot;</span>
</span><span id=__span-37-37><a id=__codelineno-37-37 name=__codelineno-37-37></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-37-38><a id=__codelineno-37-38 name=__codelineno-37-38></a><span class=w>    </span><span class=p>]</span>
</span><span id=__span-37-39><a id=__codelineno-37-39 name=__codelineno-37-39></a><span class=w>  </span><span class=p>})</span>
</span><span id=__span-37-40><a id=__codelineno-37-40 name=__codelineno-37-40></a><span class=p>}</span>
</span><span id=__span-37-41><a id=__codelineno-37-41 name=__codelineno-37-41></a>
</span><span id=__span-37-42><a id=__codelineno-37-42 name=__codelineno-37-42></a><span class=c1># Política para acessar o novo bucket do s3:</span>
</span><span id=__span-37-43><a id=__codelineno-37-43 name=__codelineno-37-43></a>
</span><span id=__span-37-44><a id=__codelineno-37-44 name=__codelineno-37-44></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_iam_role_policy_attachment&quot;</span><span class=w> </span><span class=nv>&quot;s3_lambda_test_s3_bucket_access&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-45><a id=__codelineno-37-45 name=__codelineno-37-45></a><span class=w>  </span><span class=na>role</span><span class=w>       </span><span class=o>=</span><span class=w> </span><span class=nv>aws_iam_role.s3_lambda_exec.name</span>
</span><span id=__span-37-46><a id=__codelineno-37-46 name=__codelineno-37-46></a><span class=w>  </span><span class=na>policy_arn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_iam_policy.test_s3_bucket_access.arn</span>
</span><span id=__span-37-47><a id=__codelineno-37-47 name=__codelineno-37-47></a><span class=p>}</span>
</span><span id=__span-37-48><a id=__codelineno-37-48 name=__codelineno-37-48></a>
</span><span id=__span-37-49><a id=__codelineno-37-49 name=__codelineno-37-49></a><span class=c1># Aqui teremos apoio na extração do aquivo zip da função</span>
</span><span id=__span-37-50><a id=__codelineno-37-50 name=__codelineno-37-50></a>
</span><span id=__span-37-51><a id=__codelineno-37-51 name=__codelineno-37-51></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_lambda_function&quot;</span><span class=w> </span><span class=nv>&quot;s3&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-52><a id=__codelineno-37-52 name=__codelineno-37-52></a><span class=w>  </span><span class=na>function_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;s3&quot;</span>
</span><span id=__span-37-53><a id=__codelineno-37-53 name=__codelineno-37-53></a>
</span><span id=__span-37-54><a id=__codelineno-37-54 name=__codelineno-37-54></a><span class=w>  </span><span class=na>s3_bucket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_bucket.lambda_bucket.id</span>
</span><span id=__span-37-55><a id=__codelineno-37-55 name=__codelineno-37-55></a><span class=w>  </span><span class=na>s3_key</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_object.lambda_s3.key</span>
</span><span id=__span-37-56><a id=__codelineno-37-56 name=__codelineno-37-56></a>
</span><span id=__span-37-57><a id=__codelineno-37-57 name=__codelineno-37-57></a><span class=w>  </span><span class=na>runtime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;nodejs16.x&quot;</span>
</span><span id=__span-37-58><a id=__codelineno-37-58 name=__codelineno-37-58></a><span class=w>  </span><span class=na>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;function.handler&quot;</span>
</span><span id=__span-37-59><a id=__codelineno-37-59 name=__codelineno-37-59></a>
</span><span id=__span-37-60><a id=__codelineno-37-60 name=__codelineno-37-60></a><span class=w>  </span><span class=na>source_code_hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>data.archive_file.lambda_s3.output_base64sha256</span>
</span><span id=__span-37-61><a id=__codelineno-37-61 name=__codelineno-37-61></a>
</span><span id=__span-37-62><a id=__codelineno-37-62 name=__codelineno-37-62></a><span class=w>  </span><span class=na>role</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_iam_role.s3_lambda_exec.arn</span>
</span><span id=__span-37-63><a id=__codelineno-37-63 name=__codelineno-37-63></a><span class=p>}</span>
</span><span id=__span-37-64><a id=__codelineno-37-64 name=__codelineno-37-64></a>
</span><span id=__span-37-65><a id=__codelineno-37-65 name=__codelineno-37-65></a><span class=c1># Novo grupo de logs do CloudWatch para a função:</span>
</span><span id=__span-37-66><a id=__codelineno-37-66 name=__codelineno-37-66></a>
</span><span id=__span-37-67><a id=__codelineno-37-67 name=__codelineno-37-67></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_cloudwatch_log_group&quot;</span><span class=w> </span><span class=nv>&quot;s3&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-68><a id=__codelineno-37-68 name=__codelineno-37-68></a><span class=w>  </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;/aws/lambda/${aws_lambda_function.s3.function_name}&quot;</span>
</span><span id=__span-37-69><a id=__codelineno-37-69 name=__codelineno-37-69></a>
</span><span id=__span-37-70><a id=__codelineno-37-70 name=__codelineno-37-70></a><span class=w>  </span><span class=na>retention_in_days</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>14</span>
</span><span id=__span-37-71><a id=__codelineno-37-71 name=__codelineno-37-71></a><span class=p>}</span>
</span><span id=__span-37-72><a id=__codelineno-37-72 name=__codelineno-37-72></a>
</span><span id=__span-37-73><a id=__codelineno-37-73 name=__codelineno-37-73></a>
</span><span id=__span-37-74><a id=__codelineno-37-74 name=__codelineno-37-74></a><span class=c1># &quot;Compacte a função e carregue o zip para o bucket s3:&quot;</span>
</span><span id=__span-37-75><a id=__codelineno-37-75 name=__codelineno-37-75></a>
</span><span id=__span-37-76><a id=__codelineno-37-76 name=__codelineno-37-76></a><span class=kr>data</span><span class=w> </span><span class=nc>&quot;archive_file&quot;</span><span class=w> </span><span class=nv>&quot;lambda_s3&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-77><a id=__codelineno-37-77 name=__codelineno-37-77></a><span class=w>  </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;zip&quot;</span>
</span><span id=__span-37-78><a id=__codelineno-37-78 name=__codelineno-37-78></a>
</span><span id=__span-37-79><a id=__codelineno-37-79 name=__codelineno-37-79></a><span class=w>  </span><span class=na>source_dir</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;../${path.module}/s3&quot;</span>
</span><span id=__span-37-80><a id=__codelineno-37-80 name=__codelineno-37-80></a><span class=w>  </span><span class=na>output_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;../${path.module}/s3.zip&quot;</span>
</span><span id=__span-37-81><a id=__codelineno-37-81 name=__codelineno-37-81></a><span class=p>}</span>
</span><span id=__span-37-82><a id=__codelineno-37-82 name=__codelineno-37-82></a>
</span><span id=__span-37-83><a id=__codelineno-37-83 name=__codelineno-37-83></a><span class=kr>resource</span><span class=w> </span><span class=nc>&quot;aws_s3_object&quot;</span><span class=w> </span><span class=nv>&quot;lambda_s3&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-84><a id=__codelineno-37-84 name=__codelineno-37-84></a><span class=w>  </span><span class=na>bucket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>aws_s3_bucket.lambda_bucket.id</span>
</span><span id=__span-37-85><a id=__codelineno-37-85 name=__codelineno-37-85></a>
</span><span id=__span-37-86><a id=__codelineno-37-86 name=__codelineno-37-86></a><span class=w>  </span><span class=na>key</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;s3.zip&quot;</span>
</span><span id=__span-37-87><a id=__codelineno-37-87 name=__codelineno-37-87></a><span class=w>  </span><span class=na>source</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>data.archive_file.lambda_s3.output_path</span>
</span><span id=__span-37-88><a id=__codelineno-37-88 name=__codelineno-37-88></a>
</span><span id=__span-37-89><a id=__codelineno-37-89 name=__codelineno-37-89></a><span class=w>  </span><span class=na>source_hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>filemd5</span><span class=p>(</span><span class=nv>data.archive_file.lambda_s3.output_path</span><span class=p>)</span>
</span><span id=__span-37-90><a id=__codelineno-37-90 name=__codelineno-37-90></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Vamos agora deployar diretamente na máquina local. Para isso será necessário criar um simples script wrapper no Terraform:</p> <div class="tabbed-set tabbed-alternate" data-tabs=23:1><input checked=checked id=__tabbed_23_1 name=__tabbed_23 type=radio><div class=tabbed-labels><label for=__tabbed_23_1><strong>terraform/terraform.sh</strong></label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class="language-sh highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-38-1>1</a></span>
<span class=normal><a href=#__codelineno-38-2>2</a></span>
<span class=normal><a href=#__codelineno-38-3>3</a></span>
<span class=normal><a href=#__codelineno-38-4>4</a></span>
<span class=normal><a href=#__codelineno-38-5>5</a></span>
<span class=normal><a href=#__codelineno-38-6>6</a></span>
<span class=normal><a href=#__codelineno-38-7>7</a></span>
<span class=normal><a href=#__codelineno-38-8>8</a></span>
<span class=normal><a href=#__codelineno-38-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1></a><span class=ch>#!/bin/sh</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2></a>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3></a><span class=nb>set</span><span class=w> </span>-e
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4></a>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5></a><span class=nb>cd</span><span class=w> </span>../s3
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6></a>npm<span class=w> </span>ci
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7></a>
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8></a><span class=nb>cd</span><span class=w> </span>../terraform
</span><span id=__span-38-9><a id=__codelineno-38-9 name=__codelineno-38-9></a>terraform<span class=w> </span>apply
</span></code></pre></div></td></tr></table></div> <p>(No terminal, diretório <strong>/terraform</strong>) Vamos fazer o script se tornar executável:</p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a>chmod<span class=w> </span>+x<span class=w> </span>terraform.sh
</span></code></pre></div> <p>Em seguida podemos rodar:</p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a>./terraform.sh
</span></code></pre></div> <p><img alt=Outputs src=screenshots/0020.png></p> <p>Note que, ao rodarmos o comando acima, ele automaticamente rodará nosso terraform.sh que possui um "terraform apply", <strong>aplicando imediatamente as alterações que fizemos</strong>, sem que tenhamos que utilizar novamente o comando <em>"terraform apply"</em> no terminal.</p> <p>No terminal receberemos de volta o nome do nosso recém-criado bucket do s3. Podemos invocar essa função s3 com o nome do bucket + nosso objeto para ver se o lambda conseguirá obter o objeto do bucket.</p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a>aws<span class=w> </span>lambda<span class=w> </span>invoke<span class=w> </span><span class=se>\</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a>--region<span class=o>=</span>us-east-1<span class=w> </span><span class=se>\</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a>--function-name<span class=o>=</span>s3<span class=w> </span><span class=se>\</span>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a>--cli-binary-format<span class=w> </span>raw-in-base64-out<span class=w> </span><span class=se>\</span>
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a>--payload<span class=w> </span><span class=s1>&#39;{&quot;bucket&quot;:&quot;test-&lt;your&gt;-&lt;name&gt;&quot;,&quot;object&quot;:&quot;hello.json&quot;}&#39;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-41-6><a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a>response.json
</span><span id=__span-41-7><a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a><span class=w>                             </span>/<span class=se>\</span>
</span><span id=__span-41-8><a id=__codelineno-41-8 name=__codelineno-41-8 href=#__codelineno-41-8></a><span class=w>                             </span><span class=o>||</span>
</span><span id=__span-41-9><a id=__codelineno-41-9 name=__codelineno-41-9 href=#__codelineno-41-9></a><span class=w>      </span>Substitua<span class=w> </span>test-&lt;your&gt;-&lt;name&gt;<span class=w> </span>pelo<span class=w> </span>nome<span class=w> </span><span class=k>do</span><span class=w> </span>seu<span class=w> </span>bucket
</span></code></pre></div> <p>Por fim, rode no terminal o seguinte comando:</p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a>cat<span class=w> </span>response.json
</span></code></pre></div> <p><img alt=S3_funcionando src=screenshots/0021.png></p> <p><span class="twemoji mdx-heart"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14 20.408c-.492.308-.903.546-1.192.709-.153.086-.308.17-.463.252h-.002a.75.75 0 0 1-.686 0 16.709 16.709 0 0 1-.465-.252 31.147 31.147 0 0 1-4.803-3.34C3.8 15.572 1 12.331 1 8.513 1 5.052 3.829 2.5 6.736 2.5 9.03 2.5 10.881 3.726 12 5.605 13.12 3.726 14.97 2.5 17.264 2.5 20.17 2.5 23 5.052 23 8.514c0 3.818-2.801 7.06-5.389 9.262A31.146 31.146 0 0 1 14 20.408Z"/></svg></span> &nbsp; Se você receber como retorno <strong><em>Yeah, I am working from Insper, Avelinux :)</em></strong>, parabéns, você concluiu sua aplicação e ela está funcionando!</p> <div class="admonition warning"> <p class=admonition-title>Dica Visual</p> <p>Se entrarmos no dashboard do <strong>CloudWatch</strong> novamente, conseguiremos ver os logs de acesso registrados para nossas solicitações.</p> </div> <p>Agora que você já viu todo o ambiente da sua IaaC (Infrastructure as a Code) sendo criado e funcionando, <strong>chegou a hora de destruí-lo!</strong></p> <p>Utilize o comando a seguir no seu terminal para destruir a infraestrutura:</p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a>terraform<span class=w> </span>destroy
</span></code></pre></div> <p>O resultado final deve ser algo parecido com a imagem a seguir:</p> <p><img alt=resultado src=screenshots/0029.png></p> <div class="admonition warning"> <p class=admonition-title><strong>Dica visual</strong></p> <p>Entre no dashboard da AWS e veja que todos os recursos sumiram: eles foram destruídos!</p> </div> <h2 id=conclusao>Conclusão<a class=headerlink href=#conclusao title="Permanent link">&para;</a></h2> <p>Parabéns, você acaba de construir <em>(e destruir também)</em> toda uma infraestrutura serverless na AWS! E aí, está se sentindo mais preparado para dar início aos seus próprios projetos?</p> <p>Você viu como foi <strong>bem mais fácil</strong> construir toda nossa infraestrutura rodando apenas um conjunto de códigos de uma só vez ao invés de criar serviço por serviço via dashboard da AWS?</p> <p>A intenção do handout acima era justamente essa! Queria mostrar pra vocês como o uso do Terraform facilita <em>- e muito -</em> o nosso trabalho e também mostrar um pouco o poder do uso da Computação em Nuvem. Lembre-se que <strong>o universo Cloud é imenso e possui milhares de possibilidades</strong>, então <strong>não se restrinja</strong> apenas a criar aplicações sem servidor ou sites estáticos! Conheça novos serviços e começe a desfrutar cada vez mais do incrível poder que a Computação em Nuvem pode te oferecer! <em>(E olha que eu nem estou sendo patrocinado para falar tudo isso aqui! Alô <a class="magiclink magiclink-github magiclink-mention" href=https://github.com/AWS title="GitHub User: AWS">@AWS</a>, cadê meu cachê??!!)</em></p> <p>Antes de finalizar, confira a seção <strong>"Vídeos de aprofundamento"</strong> <em>(caso você ainda não tenha conferido)</em> para entender um pouco melhor <em>(e de forma mais visual)</em> o mundo da Computação em Nuvem. Também recomendo conferir a aba <strong>"Referências"</strong>, lá eu deixei vários links que me ajudaram a compreender muito mais a fundo tudo que eu estava desenvolvendo na AWS <em>(e tudo que vocês viram neste handout)</em> durante as últimas 2 semanas <em>(sim, <strong><em>até 2 semanas atrás eu não entendia absolutamente nada de AWS</em></strong>, então se eu consegui aprender tudo isso até aqui, você também consegue).</em></p> <p>Por hoje é só! Espero que tenham gostado de todo o material que eu montei aqui. Até a próxima! Tchau :)</p> <!--
# Desenvovendo a infraestrutura

Project documentation is as diverse as the projects themselves and Material for
MkDocs is a great starting point for making it look beautiful. However, as you
write your documentation, you may reach a point where small adjustments are
necessary to preserve your brand's style.

## Adding assets

[MkDocs] provides several ways to customize a theme. In order to make a few
small tweaks to Material for MkDocs, you can just add CSS and JavaScript files to
the `docs` directory.

  [MkDocs]: https://www.mkdocs.org

### Additional CSS

If you want to tweak some colors or change the spacing of certain elements,
you can do this in a separate style sheet. The easiest way is by creating a
new style sheet file in the `docs` directory:

<div class="language-sh no-copy highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>.
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>├─<span class="w"> </span>docs/
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>│<span class="w">  </span>└─<span class="w"> </span>stylesheets/
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>│<span class="w">     </span>└─<span class="w"> </span>extra.css
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>└─<span class="w"> </span>mkdocs.yml
</span></code></pre></div>

Then, add the following lines to `mkdocs.yml`:

<div class="language-yaml highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="nt">extra_css</span><span class="p">:</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stylesheets/extra.css</span>
</span></code></pre></div>

### Additional JavaScript

If you want to integrate another syntax highlighter or add some custom logic to
your theme, create a new JavaScript file in the `docs` directory:

<div class="language-sh no-copy highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>.
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>├─<span class="w"> </span>docs/
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>│<span class="w">  </span>└─<span class="w"> </span>javascripts/
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>│<span class="w">     </span>└─<span class="w"> </span>extra.js
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>└─<span class="w"> </span>mkdocs.yml
</span></code></pre></div>

Then, add the following lines to `mkdocs.yml`:

<div class="language-yaml highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="nt">extra_javascript</span><span class="p">:</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">javascripts/extra.js</span>
</span></code></pre></div>

## Extending the theme

If you want to alter the HTML source (e.g. add or remove some parts), you can
extend the theme. MkDocs supports [theme extension], an easy way to override
parts of Material for MkDocs without forking from git. This ensures that you
can update to the latest version more easily.

  [theme extension]: https://www.mkdocs.org/user-guide/styling-your-docs/#using-the-theme-custom_dir

### Setup and theme structure

Enable Material for MkDocs as usual in `mkdocs.yml`, and create a new folder
for `overrides` which you then reference using the [`custom_dir`][custom_dir]
setting:

<div class="language-yaml highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="nt">theme</span><span class="p">:</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">material</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="w">  </span><span class="nt">custom_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overrides</span>
</span></code></pre></div>

!!! warning "Theme extension prerequisites"

    As the [`custom_dir`][custom_dir] setting is used for the theme extension
    process, Material for MkDocs needs to be installed via `pip` and referenced
    with the [`name`][name] setting in `mkdocs.yml`. It will not work when
    cloning from `git`.

The structure in the `overrides` directory must mirror the directory structure
of the original theme, as any file in the `overrides` directory will replace the
file with the same name which is part of the original theme. Besides, further
assets may also be put in the `overrides` directory:

<div class="language-sh no-copy highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>.
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>├─<span class="w"> </span>.icons/<span class="w">                             </span><span class="c1"># Bundled icon sets</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>├─<span class="w"> </span>assets/
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>│<span class="w">  </span>├─<span class="w"> </span>images/<span class="w">                          </span><span class="c1"># Images and icons</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>│<span class="w">  </span>├─<span class="w"> </span>javascripts/<span class="w">                     </span><span class="c1"># JavaScript files</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a>│<span class="w">  </span>└─<span class="w"> </span>stylesheets/<span class="w">                     </span><span class="c1"># Style sheets</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>├─<span class="w"> </span>partials/
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a>│<span class="w">  </span>├─<span class="w"> </span>integrations/<span class="w">                    </span><span class="c1"># Third-party integrations</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>│<span class="w">  </span>│<span class="w">  </span>├─<span class="w"> </span>analytics/<span class="w">                    </span><span class="c1"># Analytics integrations</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>│<span class="w">  </span>│<span class="w">  </span>└─<span class="w"> </span>analytics.html<span class="w">                </span><span class="c1"># Analytics setup</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a>│<span class="w">  </span>├─<span class="w"> </span>languages/<span class="w">                       </span><span class="c1"># Translation languages</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a>│<span class="w">  </span>├─<span class="w"> </span>actions.html<span class="w">                     </span><span class="c1"># Actions</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a>│<span class="w">  </span>├─<span class="w"> </span>comments.html<span class="w">                    </span><span class="c1"># Comment system (empty by default)</span>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a>│<span class="w">  </span>├─<span class="w"> </span>consent.html<span class="w">                     </span><span class="c1"># Consent</span>
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a>│<span class="w">  </span>├─<span class="w"> </span>content.html<span class="w">                     </span><span class="c1"># Page content</span>
</span><span id="__span-49-16"><a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a>│<span class="w">  </span>├─<span class="w"> </span>copyright.html<span class="w">                   </span><span class="c1"># Copyright and theme information</span>
</span><span id="__span-49-17"><a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a>│<span class="w">  </span>├─<span class="w"> </span>feedback.html<span class="w">                    </span><span class="c1"># Was this page helpful?</span>
</span><span id="__span-49-18"><a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a>│<span class="w">  </span>├─<span class="w"> </span>footer.html<span class="w">                      </span><span class="c1"># Footer bar</span>
</span><span id="__span-49-19"><a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a>│<span class="w">  </span>├─<span class="w"> </span>header.html<span class="w">                      </span><span class="c1"># Header bar</span>
</span><span id="__span-49-20"><a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a>│<span class="w">  </span>├─<span class="w"> </span>icons.html<span class="w">                       </span><span class="c1"># Custom icons</span>
</span><span id="__span-49-21"><a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a>│<span class="w">  </span>├─<span class="w"> </span>language.html<span class="w">                    </span><span class="c1"># Translation setup</span>
</span><span id="__span-49-22"><a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a>│<span class="w">  </span>├─<span class="w"> </span>logo.html<span class="w">                        </span><span class="c1"># Logo in header and sidebar</span>
</span><span id="__span-49-23"><a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a>│<span class="w">  </span>├─<span class="w"> </span>nav.html<span class="w">                         </span><span class="c1"># Main navigation</span>
</span><span id="__span-49-24"><a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a>│<span class="w">  </span>├─<span class="w"> </span>nav-item.html<span class="w">                    </span><span class="c1"># Main navigation item</span>
</span><span id="__span-49-25"><a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a>│<span class="w">  </span>├─<span class="w"> </span>pagination.html<span class="w">                  </span><span class="c1"># Pagination (used for blog)</span>
</span><span id="__span-49-26"><a id="__codelineno-49-26" name="__codelineno-49-26" href="#__codelineno-49-26"></a>│<span class="w">  </span>├─<span class="w"> </span>post.html<span class="w">                        </span><span class="c1"># Blog post excerpt</span>
</span><span id="__span-49-27"><a id="__codelineno-49-27" name="__codelineno-49-27" href="#__codelineno-49-27"></a>│<span class="w">  </span>├─<span class="w"> </span>search.html<span class="w">                      </span><span class="c1"># Search interface</span>
</span><span id="__span-49-28"><a id="__codelineno-49-28" name="__codelineno-49-28" href="#__codelineno-49-28"></a>│<span class="w">  </span>├─<span class="w"> </span>social.html<span class="w">                      </span><span class="c1"># Social links</span>
</span><span id="__span-49-29"><a id="__codelineno-49-29" name="__codelineno-49-29" href="#__codelineno-49-29"></a>│<span class="w">  </span>├─<span class="w"> </span>source.html<span class="w">                      </span><span class="c1"># Repository information</span>
</span><span id="__span-49-30"><a id="__codelineno-49-30" name="__codelineno-49-30" href="#__codelineno-49-30"></a>│<span class="w">  </span>├─<span class="w"> </span>source-file.html<span class="w">                 </span><span class="c1"># Source file information</span>
</span><span id="__span-49-31"><a id="__codelineno-49-31" name="__codelineno-49-31" href="#__codelineno-49-31"></a>│<span class="w">  </span>├─<span class="w"> </span>tabs.html<span class="w">                        </span><span class="c1"># Tabs navigation</span>
</span><span id="__span-49-32"><a id="__codelineno-49-32" name="__codelineno-49-32" href="#__codelineno-49-32"></a>│<span class="w">  </span>├─<span class="w"> </span>tabs-item.html<span class="w">                   </span><span class="c1"># Tabs navigation item</span>
</span><span id="__span-49-33"><a id="__codelineno-49-33" name="__codelineno-49-33" href="#__codelineno-49-33"></a>│<span class="w">  </span>├─<span class="w"> </span>tags.html<span class="w">                        </span><span class="c1"># Tags</span>
</span><span id="__span-49-34"><a id="__codelineno-49-34" name="__codelineno-49-34" href="#__codelineno-49-34"></a>│<span class="w">  </span>├─<span class="w"> </span>toc.html<span class="w">                         </span><span class="c1"># Table of contents</span>
</span><span id="__span-49-35"><a id="__codelineno-49-35" name="__codelineno-49-35" href="#__codelineno-49-35"></a>│<span class="w">  </span>└─<span class="w"> </span>toc-item.html<span class="w">                    </span><span class="c1"># Table of contents item</span>
</span><span id="__span-49-36"><a id="__codelineno-49-36" name="__codelineno-49-36" href="#__codelineno-49-36"></a>├─<span class="w"> </span><span class="m">404</span>.html<span class="w">                            </span><span class="c1"># 404 error page</span>
</span><span id="__span-49-37"><a id="__codelineno-49-37" name="__codelineno-49-37" href="#__codelineno-49-37"></a>├─<span class="w"> </span>base.html<span class="w">                           </span><span class="c1"># Base template</span>
</span><span id="__span-49-38"><a id="__codelineno-49-38" name="__codelineno-49-38" href="#__codelineno-49-38"></a>├─<span class="w"> </span>blog.html<span class="w">                           </span><span class="c1"># Blog index page</span>
</span><span id="__span-49-39"><a id="__codelineno-49-39" name="__codelineno-49-39" href="#__codelineno-49-39"></a>├─<span class="w"> </span>blog-archive.html<span class="w">                   </span><span class="c1"># Blog archive index page</span>
</span><span id="__span-49-40"><a id="__codelineno-49-40" name="__codelineno-49-40" href="#__codelineno-49-40"></a>├─<span class="w"> </span>blog-category.html<span class="w">                  </span><span class="c1"># Blog category index page</span>
</span><span id="__span-49-41"><a id="__codelineno-49-41" name="__codelineno-49-41" href="#__codelineno-49-41"></a>├─<span class="w"> </span>blog-post.html<span class="w">                      </span><span class="c1"># Blog post page</span>
</span><span id="__span-49-42"><a id="__codelineno-49-42" name="__codelineno-49-42" href="#__codelineno-49-42"></a>└─<span class="w"> </span>main.html<span class="w">                           </span><span class="c1"># Default page</span>
</span></code></pre></div>

  [custom_dir]: https://www.mkdocs.org/user-guide/configuration/#custom_dir
  [name]: https://www.mkdocs.org/user-guide/configuration/#name

### Overriding partials

In order to override a partial, we can replace it with a file of the same name
and location in the `overrides` directory. For example, to replace the original
`footer.html` partial, create a new `footer.html` partial in the `overrides`
directory:

<div class="language-sh no-copy highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>.
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>├─<span class="w"> </span>overrides/
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>│<span class="w">  </span>└─<span class="w"> </span>partials/
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>│<span class="w">     </span>└─<span class="w"> </span>footer.html
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>└─<span class="w"> </span>mkdocs.yml
</span></code></pre></div>

MkDocs will now use the new partial when rendering the theme. This can be done
with any file.

### Overriding blocks <small>recommended</small> { #overriding-blocks data-toc-label="Overriding blocks" }

Besides overriding partials, it's also possible to override (and extend)
template blocks, which are defined inside the templates and wrap specific
features. In order to set up block overrides, create a `main.html` file inside
the `overrides` directory:

<div class="language-sh no-copy highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>.
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>├─<span class="w"> </span>overrides/
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>│<span class="w">  </span>└─<span class="w"> </span>main.html
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>└─<span class="w"> </span>mkdocs.yml
</span></code></pre></div>

Then, e.g. to override the site title, add the following lines to `main.html`:

<div class="language-html highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>{% extends &quot;base.html&quot; %}
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>{% block htmltitle %}
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Lorem ipsum dolor sit amet<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>{% endblock %}
</span></code></pre></div>

If you intend to __add__ something to a block rather than to replace it
altogether with new content, use `{{ super() }}` inside the block to include the
original block content. This is particularly useful when adding third-party
scripts to your docs, e.g.

<div class="language-html highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>{% extends &quot;base.html&quot; %}
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>{% block scripts %}
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>  <span class="cm">&lt;!-- Add scripts that need to run before here --&gt;</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>{{ super() }}
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>  <span class="cm">&lt;!-- Add scripts that need to run afterwards here --&gt;</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>{% endblock %}
</span></code></pre></div>

The following template blocks are provided by the theme:

| Block name        | Purpose                                         |
| :---------------- | :---------------------------------------------- |
| `analytics`       | Wraps the Google Analytics integration          |
| `announce`        | Wraps the announcement bar                      |
| `config`          | Wraps the JavaScript application config         |
| `container`       | Wraps the main content container                |
| `content`         | Wraps the main content                          |
| `extrahead`       | Empty block to add custom meta tags             |
| `fonts`           | Wraps the font definitions                      |
| `footer`          | Wraps the footer with navigation and copyright  |
| `header`          | Wraps the fixed header bar                      |
| `hero`            | Wraps the hero teaser (if available)            |
| `htmltitle`       | Wraps the `<title>` tag                         |
| `libs`            | Wraps the JavaScript libraries (header)         |
| `outdated`        | Wraps the version warning                       |
| `scripts`         | Wraps the JavaScript application (footer)       |
| `site_meta`       | Wraps the meta tags in the document head        |
| `site_nav`        | Wraps the site navigation and table of contents |
| `styles`          | Wraps the style sheets (also extra sources)     |
| `tabs`            | Wraps the tabs navigation (if available)        |

## Theme development

Material for MkDocs is built on top of [TypeScript], [RxJS] and [SASS], and
uses a lean, custom build process to put everything together.[^1] If you want
to make more fundamental changes, it may be necessary to make the adjustments
directly in the source of the theme and recompile it.

  [^1]:
    Prior to :octicons-tag-24: 7.0.0 the build was based on Webpack, resulting
    in occasional broken builds due to incompatibilities with loaders and
    plugins. Therefore, we decided to swap Webpack for a leaner solution which
    is now based on [RxJS] as the application itself. This allowed for the
    pruning of more than 500 dependencies (~30% less).

  [TypeScript]: https://www.typescriptlang.org/
  [RxJS]: https://github.com/ReactiveX/rxjs
  [SASS]: https://sass-lang.com

### Environment setup

In order to start development on Material for MkDocs, a [Node.js] version of
at least 14 is required. First, clone the repository:

<div class="language-text highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>git clone https://github.com/squidfunk/mkdocs-material
</span></code></pre></div>

Next, all dependencies need to be installed, which is done with:

<div class="language-text highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>cd mkdocs-material
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>pip install -e .
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>pip install mkdocs-minify-plugin
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>pip install mkdocs-redirects
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>npm install
</span></code></pre></div>

  [Node.js]: https://nodejs.org

### Development mode

Start the watcher with:

<div class="language-text highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>npm start
</span></code></pre></div>

Then, in a second terminal window, start the MkDocs live preview server with:

```

mkdocs serve --watch-theme

````

Point your browser to [localhost:8000][live preview] and you should see this
very documentation in front of you.

!!! warning "Automatically generated files"

    Never make any changes in the `material` directory, as the contents of this
    directory are automatically generated from the `src` directory and will be
    overwritten when the theme is built.

  [live preview]: http://localhost:8000

### Building the theme

When you're finished making your changes, you can build the theme by invoking:

``` sh
npm run build # (1)!
````

1.  While this command will build all theme files, it will skip the overrides
    used in Material for MkDocs' own documentation which are not distributed
    with the theme. If you forked the theme and want to build the overrides
    as well, use:

    ```
    npm run build:all
    ```

    This will take longer, as now the icon search index, schema files, as
    well as additional style sheet and JavaScript files are built.

This triggers the production-level compilation and minification of all style
sheets and JavaScript files. After the command exits, the compiled files are
located in the `material` directory. When running `mkdocs build`, you should
now see your changes to the original theme. --> </article> </div> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Conteúdo desenvolvido por Lister Ogusuku Ribeiro ©2023 | Engenharia de Computação - Insper </div> </div> <div class=md-social> <a href=https://github.com/listerogusuku target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../assets/javascripts/bundle.fac441b0.min.js></script> <script src=../assets/javascripts/custom.13133f3f.min.js></script> </body> </html>